<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>22 Three.jsä¼˜åŒ–ä¹‹OffscreenCanvasä¸WebWorker | Bablvsj's Blog</title><meta name=keywords content="Three.js"><meta name=description content="22 Three.jsä¼˜åŒ–ä¹‹OffscreenCanvasä¸WebWorker - Bablvsj's Blog"><meta name=author content><link rel=canonical href=https://bablvsj.github.io/posts/threejs/22-three.js%E4%BC%98%E5%8C%96%E4%B9%8Boffscreencanvas%E4%B8%8Ewebworker/><link crossorigin=anonymous href=/assets/css/stylesheet.b33b75c69bb2ec0d4accfeaad1d3ba05b272f180583f687c640a522d6492076f.css integrity="sha256-szt1xpuy7A1KzP6q0dO6BbJy8YBYP2h8ZApSLWSSB28=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://bablvsj.github.io/img/Q.gif><link rel=icon type=image/png sizes=16x16 href=https://bablvsj.github.io/img/Q.gif><link rel=icon type=image/png sizes=32x32 href=https://bablvsj.github.io/img/Q.gif><link rel=apple-touch-icon href=https://bablvsj.github.io/Q.gif><link rel=mask-icon href=https://bablvsj.github.io/Q.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=stylesheet href=/css/syntax.css><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="22 Three.jsä¼˜åŒ–ä¹‹OffscreenCanvasä¸WebWorker"><meta property="og:description" content><meta property="og:type" content="article"><meta property="og:url" content="https://bablvsj.github.io/posts/threejs/22-three.js%E4%BC%98%E5%8C%96%E4%B9%8Boffscreencanvas%E4%B8%8Ewebworker/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-19T17:11:35+08:00"><meta property="article:modified_time" content="2023-12-19T17:11:35+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="22 Three.jsä¼˜åŒ–ä¹‹OffscreenCanvasä¸WebWorker"><meta name=twitter:description content><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"æ–‡ç« ","item":"https://bablvsj.github.io/posts/"},{"@type":"ListItem","position":3,"name":"22 Three.jsä¼˜åŒ–ä¹‹OffscreenCanvasä¸WebWorker","item":"https://bablvsj.github.io/posts/threejs/22-three.js%E4%BC%98%E5%8C%96%E4%B9%8Boffscreencanvas%E4%B8%8Ewebworker/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"22 Three.jsä¼˜åŒ–ä¹‹OffscreenCanvasä¸WebWorker","name":"22 Three.jsä¼˜åŒ–ä¹‹OffscreenCanvasä¸WebWorker","description":"","keywords":["Three.js"],"articleBody":"æˆ‘ä»¬çŸ¥é“ JS æ˜¯å•çº¿ç¨‹ï¼Œå¯ä»¥é€šè¿‡ WebWorker å°†ä¸€äº›å¤æ‚è®¡ç®—æ‰§è¡Œå‘½ä»¤ä»ä¸»çº¿ç¨‹ä¸­åˆ†ç¦»å‡ºæ¥ã€‚\nå…³äº WebWorker çš„ä½¿ç”¨æ–¹æ³•ï¼Œè¯·å‚è€ƒï¼š\nhttps://developer.mozilla.org/zh-cn/docs/web/api/web_workers_api/using_web_workers\næˆ–è€…æŸ¥çœ‹æˆ‘å†™çš„å¦å¤–ä¸€ç¯‡æ–‡ç« ï¼šWebWorkerå­¦ä¹ ç¬”è®°.md\nä¸€äº›æ¯”è¾ƒæ–°çš„æµè§ˆå™¨(ä¾‹å¦‚è°·æ­Œæµè§ˆå™¨) è¿˜æœ‰å¦å¤–ä¸€ä¸ªå’Œ WebWorker æ­é…ä½¿ç”¨ã€é’ˆå¯¹ç”»å¸ƒçš„ç±»ï¼šOffscreenCanvasã€‚\nOffscreenCanvas çš„ä½œç”¨å°±æ˜¯å°† canvas çš„æ§åˆ¶æƒè½¬è®©ç»™ Web Workerã€‚\nå› æ­¤ OffscreenCanvas å¿…é¡»æ­é… Web Worker ä¸€èµ·ä½¿ç”¨ã€‚\nè¡¥å……ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼š\nå’Œ OffscreenCanvas ç±»ä¼¼çš„è¿˜æœ‰ ArrayBufferã€ MessagePortã€ImageBitmapï¼Œä»–ä»¬éƒ½å¯ä»¥ä¸ WebWorker æ­é…ä½¿ç”¨\nOffscreenCanvasçš„æ¦‚å¿µå’Œç”¨æ³• OffscreenCanvasçš„åŸºæœ¬æ¦‚å¿µ ä½ å¯ä»¥æŠŠ WebWorker åšä¸ºå„ç§å¤æ‚ç±»å‹çš„åå°è¿ç®—çº¿ç¨‹ï¼Œä½œç”¨èŒƒå›´æ¯”è¾ƒå¹¿æ³›ã€‚\nè€Œ OffscreenCanvas åˆ™ä¸“é—¨é’ˆå¯¹ Canvas åšç¦»å±æ¸²æŸ“ã€‚\næ³¨æ„ï¼Œè¿™é‡Œæåˆ°çš„ ç¦»å±æ¸²æŸ“ å’Œ æˆ‘ä»¬ä½¿ç”¨ WebGLRendererTarget æ¥åšçš„ç¦»å±æ¸²æŸ“ï¼Œä»æ¦‚å¿µä¸Šæ˜¯ç±»ä¼¼çš„\nOffscreenCanvas çš„ â€œç¦»å±â€ æ˜¯æŒ‡æµè§ˆå™¨ DOM è€Œè¨€\nWebGLRenderTarget çš„ â€œç¦»å±â€ åªæŒ‡ Three.js çš„ä¸»åœºæ™¯(Scene) è€Œè¨€\nä½ å¯ä»¥æŠŠ OffscreenCanvas çœ‹ä½œæ˜¯é’ˆå¯¹ Canvas çš„ç‰¹æ®Š WebWorker åº”ç”¨åœºæ™¯ã€‚\nä½†æ˜¯è¯·è®°å¾—ï¼šç›®å‰ç»å¤§å¤šæ•°æµè§ˆå™¨å‡å·²æ”¯æŒ WebWorkerï¼Œä½†æ˜¯å¯¹ OffscreenCanvas çš„æ”¯æŒåº¦å¹¶ä¸é«˜ã€‚\nå¦‚ä½•åˆ›å»º OffscreenCanvas ï¼Ÿ\nä¸å¯ä»¥ä½¿ç”¨ new OffscreenWorker() çš„æ–¹å¼æ¥åˆ›å»º OffscreenCanvasï¼Œè€Œæ˜¯ä½¿ç”¨ canvas.transferControlToOffscreen() æ¥è·å¾— canvas å¯¹åº”çš„ OffscreenCanvasã€‚\nå¦‚ä½•æ£€æµ‹å½“å‰æµè§ˆå™¨æ˜¯å¦æ”¯æŒ OffscreenCanvasï¼Ÿ\næˆ‘ä»¬åªéœ€æ£€æŸ¥ canvas æ˜¯å¦å­˜åœ¨ transferControlToOffscreen æ–¹æ³•ï¼š\nif(canvas.transferControlToOffscreen !== null){ console.log('å½“å‰æµè§ˆå™¨æ”¯æŒ OffscreenCanvas') }else{ console.log('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ OffscreenCanvas') } æˆ‘ä»¬æ˜¯é€šè¿‡æ£€æŸ¥ canvas å¯¹è±¡ä¸Šæ˜¯å¦åŒ…å« .transferControlToOffscreen æ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦å½“å‰æµè§ˆå™¨æ”¯æŒ OffscreenCanvas çš„ã€‚\nè¿™é‡Œè¡¥å……ä¸€ä¸ª JS çŸ¥è¯†ï¼Œå¦‚ä½•åˆ¤æ–­æŸä¸ªå¯¹è±¡ä¸Šæ˜¯å¦æœ‰æŸä¸ªå±æ€§ã€‚\nå‡è®¾æœ‰ä¸€ä¸ªå¯¹è±¡\nconst obj = { a:undefined, b:null } æ­¤æ—¶æˆ‘ä»¬ä½¿ç”¨ if(obj.a) æˆ– if(obj.b) éƒ½æ˜¯æ— æ³•å‡†ç¡®åˆ¤æ–­å‡ºåˆ°åº• å±æ€§ aã€b æ˜¯å¦å­˜åœ¨ã€‚\né‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ 2 ç§æ–¹å¼æ¥è¿›è¡Œåˆ¤æ–­ï¼š\nif('a' in obj) { ... } if(Reflect.has(obj,'b')){ ... } ä½¿ç”¨ in æˆ–è€… Reflect.has() å°±å¯ä»¥å‡†ç¡®åˆ¤æ–­å‡ºå¯¹è±¡ä¸Šæ˜¯å¦å…·æœ‰æŸå±æ€§æˆ–æ–¹æ³•ï¼Œå³ä½¿è¯¥å±æ€§çš„å€¼ä¸º undefined\næ³¨æ„ï¼šä¸Šé¢ 2 ç§æŸ¥è¯¢æ–¹å¼éƒ½éœ€è¦å±æ€§åçš„å­—ç¬¦ä¸²å€¼ï¼Œä¸ºäº†æ›´å¥½çš„è¯­æ³•æç¤ºï¼Œæˆ‘ä»¬ç¤ºä¾‹ä¸­å¹¶ä¸è¿™æ ·ç”¨ã€‚\nOffscreenCanvasçš„ç”¨æ³• å†æ¬¡å¼ºè°ƒï¼šé€šå¸¸æƒ…å†µä¸‹ OffscreenCanvas å¿…é¡»æ­é… Web Worker ä¸€èµ·ä½¿ç”¨ã€‚\næˆ‘ä»¬å•ç‹¬åˆ›å»ºä¸€ä¸ª JS æ–‡ä»¶ï¼Œå°† canvas ç»˜åˆ¶çš„ä¸€äº› JS ä»£ç å†™åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ã€‚\nå¤§ä½“æ­¥éª¤ï¼š\nåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ JS æ–‡ä»¶ï¼Œç”¨æ¥ç¼–å†™ Three.js åœºæ™¯å†…å®¹å’Œæ¸²æŸ“ä»£ç \nä¼šä»¥è¿™ä¸ª JS æ–‡ä»¶æ¥ä½œä¸º web worker çš„è°ƒç”¨æ–‡ä»¶å¯¹è±¡\nåœ¨ä¸»åœºæ™¯ä¸­ï¼Œè·å¾— DOM ä¸­çš„ canvas\nè·å– canvas å¯¹åº”çš„ OffscreenCanvas\nconst offscreen = canvas.transferCountrolToOffscreen() åˆ›å»ºä¸€ä¸ª worker å¯¹è±¡ï¼Œå¹¶ä¸”è®¾ç½®ä¸€äº›æ¶ˆæ¯å‚æ•°\nconst worker = new Window.Worker('xx/xxxx.js',{type:'module'}) worker.postMessage({type:'main',canvas:offscreen},[offscreen]) ç”±äº web worker ä¸å…è®¸è®¿é—® DOM äº‹ä»¶ï¼Œä¾‹å¦‚æµè§ˆå™¨çª—å£å°ºå¯¸æ”¹å˜äº‹ä»¶ã€é¼ æ ‡äº‹ä»¶ç­‰ï¼Œæ‰€ä»¥å½“è¿™äº›äº‹ä»¶å‘ç”Ÿåï¼Œæˆ‘ä»¬éœ€è¦é€šçŸ¥ workerï¼Œå°†äº‹ä»¶å¯¹åº”çš„ä¸€äº›å‚æ•°å’Œå˜åŠ¨å‘é€ç»™ workerï¼Œä»¥ä¾¿ worker ä¸­çš„ canvas æ¸²æŸ“é€»è¾‘ä½œå‡ºå¯¹åº”çš„å“åº”ã€‚\nçª—å£å°ºå¯¸æ”¹å˜äº‹ä»¶æˆ‘ä»¬è¿˜æ¯”è¾ƒå®¹æ˜“è§£å†³ï¼Œæ— éå°±æ˜¯æŠŠæ–°çš„å°ºå¯¸å‘é€ç»™ workerï¼Œæ¯”è¾ƒéš¾çš„æ˜¯åƒ é¼ æ ‡äº‹ä»¶ã€é”®ç›˜äº‹ä»¶ç­‰ï¼Œéœ€è¦ç¨å¾®å¤æ‚çš„ä¸€äº›ä¼ é€’æ–¹å¼æ‰å¯ä»¥è§£å†³ã€‚\nåœ¨æœ¬æ–‡ååŠéƒ¨åˆ†ä¼šæœ‰è¯¦ç»†è®²è§£ã€‚\nå®é™…å·®å¼‚ï¼š\nåˆšæ‰å°†çš„æ˜¯ç†è®ºä¸Šå¤§ä½“æ­¥éª¤ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬æœ¬æ•™ç¨‹çš„ç¤ºä¾‹ä»£ç ï¼Œå®é™…ä¸Šæ˜¯è¿è¡Œåœ¨ React + TypeScript ç¯å¢ƒä¸Šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦ç¼–å†™çš„æ˜¯ worker.ts è€Œä¸æ˜¯ worker.jsã€‚\nå½“ç„¶ä½ ä¹Ÿå¯ä»¥é‡‡å–åœ¨ç¼–å†™ worker æ—¶ä½¿ç”¨ .js è€Œä¸æ˜¯ .tsï¼Œåªä¸è¿‡è¿™æ ·å°±å¤±å»äº† TypeScript çš„ä¾¿åˆ©æ€§ã€‚\næˆ‘ä»¬æ¨èçš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ webpack çš„æ’ä»¶ï¼šworker-loader æ¥è§£å†³ react + typescript ç¯å¢ƒä¸­ç¼–å†™ workerã€‚\nå…·ä½“çš„é…ç½®æ­¥éª¤ï¼Œè¯·å‚è€ƒæˆ‘å†™çš„å¦å¤–ä¸€ç¯‡æ–‡ç« ï¼šReactå†…åµŒWebWorkerä»£ç \næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼Œæ¥æ¼”ç¤ºä¸€é OffscreenCanvas + Workerã€‚\nç¦»å±ç”»å¸ƒæ¸²æŸ“ç¤ºä¾‹ï¼šHelloOffscreenCanvas å‡è®¾ä½ å·²ç»é…ç½®å¥½äº† worker-loaderï¼Œé‚£ä¹ˆæˆ‘ä»¬å¼€å§‹æœ¬ç¤ºä¾‹ã€‚\nç¤ºä¾‹ç›®æ ‡ åœºæ™¯ä¸Šæœ‰ 3 ä¸ªä¸åŒé¢œè‰²ï¼Œä¸æ–­æ—‹è½¬çš„ç«‹æ–¹ä½“ æˆ‘ä»¬å°†åœºæ™¯ä¸­çš„æ¸²æŸ“å·¥ä½œï¼Œä»ä¸»ç¨‹åºä¸­æŠ½ç¦»å‡ºå»ï¼Œè®© Web Worker æ¥è´Ÿè´£åœºæ™¯çš„æ¸²æŸ“å·¥ä½œï¼Œä¾æ¬¡æ¥å‡è½»ä¸»ç¨‹åºçš„è¿ç®—è´Ÿæ‹…ã€‚ è¡¥å……è¯´æ˜ï¼š\næˆ‘ä»¬åœºæ™¯ä¸­åŠ¨ç”»æ¸²æŸ“æœ¬èº«è®¡ç®—é‡å¹¶ä¸æ˜¯å¾ˆå¤§ï¼Œå³ä½¿æˆ‘ä»¬ä¸ä½¿ç”¨ web worker æµè§ˆå™¨ä¹Ÿä¸ä¼šå¡é¡¿ï¼Œä½†æœ¬ç¤ºä¾‹åªæ˜¯ä¸ºäº†æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ OffscreenCanvas + Workerã€‚ æˆ‘ä»¬å…ˆå‡è®¾ä½ çš„æµè§ˆå™¨æ˜¯æ”¯æŒ OffscreenCanvas çš„ã€‚ å…³é”®ç‚¹è¯´æ˜ é»˜è®¤ ä¸»ç¨‹åº(index.tsx æˆ– index.ts) ä¸ åˆ†çº¿ç¨‹(Worker.ts) å½¼æ­¤é€šè¿‡ .postMessage() äº’ç›¸å‘é€æ•°æ®ã€‚\nè€Œ .postMessage() é»˜è®¤å‘é€çš„æ•°æ®æ˜¯æ·±æ‹·è´ï¼Œè€Œä¸æ˜¯å¼•ç”¨ã€‚\nå› ä¸ºæœ¬è´¨ä¸Š index.tsx å’Œ worker.ts å°±ä¸åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œæ— æ³•å…±äº«æ•°æ®\næ”¯æŒå…±äº«æ•°æ®çš„ SharedWorker ç›®å‰æµè§ˆå™¨æ”¯æŒåº¦è¿˜ä¸å¤Ÿé«˜ã€‚\nå‡è®¾æˆ‘ä»¬æ˜¯æŠŠåœºæ™¯æ¸²æŸ“çš„è®¡ç®—å·¥ä½œè½¬ç§»åˆ°äº† worker.ts ä¸­ï¼Œä½†æ˜¯ worker.ts æ¯æ¬¡è®¡ç®—å¥½ canvas ç”»é¢å†…å®¹åå†å‘é€ç»™ index.tsxï¼Œæ¯æ¬¡éƒ½æ‰§è¡Œä¸€æ¬¡æ·±æ‹·è´ï¼Œæ€§èƒ½åè€Œä½ä¸‹ã€‚\nWeb Worker æœ¬èº«æ˜¯æ— æ³•è®¿é—® DOM å…ƒç´ çš„\nå¹¸å¥½ .postMessage() æ–¹æ³•çš„ç¬¬ 2 ä¸ªå‚æ•°ï¼Œå…è®¸æˆ‘ä»¬å°†ä¸€äº›æ•°æ®ç±»å‹æ¯”è¾ƒå¤§çš„å¯¹è±¡ï¼Œç›´æ¥å°†æ§åˆ¶æƒè½¬ç§»ç»™ worker.tsã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼ŒOffscreenCanvas + Worker ä¸æ˜¯èµ°ä»¥ä¸‹æµç¨‹ï¼š\nworker.ts è´Ÿè´£åˆ›å»º Three.js åœºæ™¯å’Œç‰©ä½“ worket.ts è´Ÿè´£æ¸²æŸ“å¾—åˆ° åœºæ™¯ç”»é¢æ•°æ® worket.ts é€šè¿‡ .postMessage() å°†ç¦»å±æ¸²æŸ“å¾—åˆ°çš„ ç”»å¸ƒç”»é¢å†…å®¹æ•°æ® å‘é€ç»™ index.tsx index.tsx æ¥æ”¶ ç”»å¸ƒç”»é¢å†…å®¹æ•°æ® å¹¶æ¸²æŸ“åˆ° canvas DOM ä¸­ è€Œæ˜¯èµ°ä»¥ä¸‹æµç¨‹ï¼š\nindex.tsx é€šè¿‡ canvas.transferToOffscreenCanvas() å¾—åˆ° OffscreenCanvas index.tsx é€šè¿‡ .postMessage() ç¬¬ 2 ä¸ªå‚æ•°ï¼Œå°† [OffscreenCanavs] ä¼ é€’ç»™ worker.tsï¼Œä¹Ÿå°±æ˜¯è¯´å°† canvas çš„æ§åˆ¶æƒå®Œå…¨äº¤ç»™ worker.ts æ¥ä¸‹æ¥å°±æ˜¯ worker.ts è´Ÿè´£åˆ›å»º Three.js åœºæ™¯å’Œç‰©ä½“ï¼Œå¹¶ä¸”æ¸²æŸ“åœºæ™¯ç”»é¢å†…å®¹ç›´æ¥èµ‹äºˆç»™ OffscreenCanavasã€‚ å…¶ä»–è¡¥å…… ç”±äº worker æœ¬èº«æ— æ³•è·å– DOM ï¼Œä»¥åŠæ— æ³•è·å–æµè§ˆå™¨æŸäº›äº‹ä»¶ï¼Œä¾‹å¦‚æµè§ˆå™¨çš„çª—å£å¤§å°å˜åŠ¨äº‹ä»¶ã€‚\næ‰€ä»¥å½“æµè§ˆå™¨çª—å£å°ºå¯¸å‘ç”Ÿå˜åŒ–åï¼Œæˆ‘ä»¬è¦è®© index.tsx åŠæ—¶é€šçŸ¥ worker.ts æ–°çš„æµè§ˆå™¨çª—å£å®½é«˜ï¼Œä»¥ä¾¿è®© worker.ts ä½œå‡ºç›¸åº”çš„è°ƒæ•´ã€‚\nä¸çª—å£å°ºå¯¸æ”¹å˜ç›¸ä¼¼çš„è¿˜æœ‰é¼ æ ‡ç§»åŠ¨äº‹ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¼ é€’å½“å‰é¼ æ ‡åæ ‡ä½ç½®ä¼ é€’ç»™ Worker ä»¥ä¾¿åšå‡ºç›¸åº”çš„å¤„ç†ã€‚åæœŸæˆ‘ä»¬ä¼šå­¦ä¹ å¦‚ä½•åšåœºæ™¯ç‰©ä½“æ‹¾å–æ•ˆæœï¼Œå°±æ˜¯é¼ æ ‡æ”¾åˆ°æŸä¸ªç‰©ä½“ä¸Šæ—¶ç‰©ä½“åšå‡ºç›¸åº”å˜åŒ–ï¼Œè¿™ç§åœºæ™¯å°±ä¼šéœ€è¦ç”¨åˆ°é¼ æ ‡åæ ‡ã€‚\næ¥ä¸‹æ¥ï¼Œå°±å¼€å§‹å…·ä½“ç¼–å†™ä»£ç å§ã€‚\nmessage-data.ts src/components/hello-offscreen-canvas/message-data.ts\nmessage-data.ts çš„ä½œç”¨æ˜¯å®šä¹‰ä¸€äº›å‚æ•°åã€å‚æ•°å€¼çš„ç±»å‹ï¼Œä»¥ä¾¿æˆ‘ä»¬è·å¾—å¥½çš„ TS è¯­æ³•æç¤ºã€‚\næ³¨æ„ï¼šmessage-data.ts ä¼šåŒæ—¶è¢« index.tsx å’Œ worker.ts å¼•å…¥ï¼Œè¿™æ ·åšçš„æ•ˆæœæ˜¯ï¼š\nindex.tsx å¯ä»¥æ¯”è¾ƒå®¹æ˜“çŸ¥é“ worker.ts å†…éƒ¨å®šä¹‰çš„å‡½æ•°åå«ä»€ä¹ˆ worker.ts å¯ä»¥æ¯”è¾ƒå®¹æ˜“çŸ¥é“ index.tsx ä¼ é€’è¿‡æ¥çš„å‚æ•°ç±»å‹æ˜¯ä»€ä¹ˆ //å®šä¹‰ç”»å¸ƒçš„å°ºå¯¸ç±»å‹æ•°æ®ç»“æ„ export type CanvasSize = { width: number, height: number } export enum WorkerFunName { main = 'main', updateSize = 'updateSize' } //å®šä¹‰ MessageEvent data çš„æ•°æ®ç»“æ„ export type MessageData = { type: WorkerFunName.main, params: OffscreenCanvas } | { type: WorkerFunName.updateSize, params: CanvasSize } worker.ts src/components/hello-offscreen-canvas/worker.ts\nimport * as Three from 'three' import { CanvasSize, MessageData, WorkerFunName } from './message-data' let renderer: Three.WebGLRenderer let camera: Three.PerspectiveCamera let scene: Three.Scene //å®šä¹‰åˆå§‹åŒ–çš„å‡½æ•° const main = (canvas: OffscreenCanvas) =\u003e { //å¼€å§‹åˆ›å»º 3D ç›¸å…³åœºæ™¯ renderer = new Three.WebGLRenderer({ canvas }) camera = new Three.PerspectiveCamera(45, 2, 0.1, 100) camera.position.z = 4 scene = new Three.Scene() const colors = ['blue', 'red', 'green'] const cubes: Three.Mesh[] = [] colors.forEach((color, index) =\u003e { const material = new Three.MeshPhongMaterial({ color }) const geometry = new Three.BoxBufferGeometry(1, 1, 1) const mesh = new Three.Mesh(geometry, material) mesh.position.x = (index - 1) * 2 scene.add(mesh) cubes.push(mesh) }) const light = new Three.DirectionalLight(0xFFFFFF, 1) light.position.set(-2, 2, 2) scene.add(light) const render = (time: number) =\u003e { time *= 0.001 cubes.forEach((item) =\u003e { item.rotation.set(time, time, 0) }) renderer.render(scene, camera) self.requestAnimationFrame(render) } self.requestAnimationFrame(render) } //å®šä¹‰ç”¨æ¥æ¥æ”¶ç”»å¸ƒå°ºå¯¸æ›´æ–°çš„å‡½æ•° const updateSize = (newSize: CanvasSize) =\u003e { camera.aspect = newSize.width / newSize.height camera.updateProjectionMatrix() renderer.setSize(newSize.width, newSize.height, false) } const handleMessage = ((eve: MessageEvent) =\u003e { switch (eve.data.type) { case WorkerFunName.main: main(eve.data.params) break case WorkerFunName.updateSize: updateSize(eve.data.params) break default: throw new Error(`no handle for the type`) } }) self.addEventListener('message', handleMessage) const handleMessageError = () =\u003e { throw new Error('Worker.ts: message error ...') } self.addEventListener('messageerror', handleMessageError) //å¯¼å‡º {} æ˜¯å› ä¸º .ts ç±»å‹çš„æ–‡ä»¶å¿…é¡»æœ‰å¯¼å‡ºå¯¹è±¡æ‰å¯ä»¥è¢« TS ç¼–è¯‘æˆæ¨¡å—ï¼Œè€Œä¸æ˜¯å…¨å±€å¯¹è±¡ export { } index.tsx src/components/hello-offscreen-canvas/index.tsx\nimport { useEffect, useRef } from 'react' import { WorkerFunName } from './message-data' import Worker from 'worker-loader!./worker' import './index.scss' const HelloOffscreenCanvas = () =\u003e { const canvasRef = useRef(null) useEffect(() =\u003e { if (canvasRef.current === null) { return } const canvas = canvasRef.current as HTMLCanvasElement const offscreen = canvas.transferControlToOffscreen() const worker = new Worker() worker.postMessage({ type: WorkerFunName.main, params: offscreen}, [offscreen]) const handleMessageError = (error: MessageEvent) =\u003e { console.log(error) } const handleError = (error: ErrorEvent) =\u003e { console.log(error) } worker.addEventListener('messageerror', handleMessageError) worker.addEventListener('error', handleError) const handleResize = () =\u003e { worker.postMessage({ type: WorkerFunName.updateSize, params: { width: canvas.clientWidth, height: canvas.clientHeight } }) } handleResize() window.addEventListener('resize', handleResize) return () =\u003e { worker.removeEventListener('messageerror', handleMessageError) worker.removeEventListener('error', handleError) } }, [canvasRef]) return ( ) } export default HelloOffscreenCanvas æˆ‘ä»¬å¯ä»¥çœ‹åˆ° index.tsx ä¸­å·²ç»æ²¡æœ‰ä»»ä½• Three.js ç›¸å…³çš„ä»£ç äº†ã€‚\nè¿è¡Œè°ƒè¯•ä¸€åˆ‡æ­£å¸¸ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬è¦è§£å†³ 2 ä¸ªé—®é¢˜ï¼š\næ§åˆ¶ 3D åœºæ™¯ç”¨åˆ°çš„ OrbitControls ç±»ï¼Œåœ¨æ–°å»ºæ—¶éœ€è¦ä¼ é€’ HTML DOM å…ƒç´ ï¼Œäº¤äº’çš„è¿‡ç¨‹ä¸­éœ€è¦ DOM å…ƒç´ çš„é¼ æ ‡äº‹ä»¶å’Œé”®ç›˜äº‹ä»¶ï¼Œä½†æ˜¯ worker å†…éƒ¨åˆä¸èƒ½è®¿é—® DOM å…ƒç´ ï¼Œé‚£è¯¥å¦‚ä½•è§£å†³ï¼Ÿ\nå‡è®¾æµè§ˆå™¨ä¸æ”¯æŒ OffscreenCanvas ï¼Œé‚£åˆè¯¥å¦‚ä½•æ‹†åˆ†æˆ‘ä»¬çš„ä»£ç å¯ä»¥åšåˆ°å…¼å®¹ï¼Ÿ\nåœ¨è½¯ä»¶å¼€å‘æœ¯è¯­ä¸­ï¼Œä¼šä½¿ç”¨ â€œé²æ£’æ€§æˆ–å¥å£®æ€§â€ æ¥æŒ‡ä»£ç çš„å…¼å®¹æ€§å’Œå®¹é”™æ€§ã€‚\næ¨¡æ‹Ÿå¹¶æ·»åŠ OrbitControls ä½ éœ€è¦å…ˆå¿˜è®°æˆ‘ä»¬ä¸Šé¢åˆšæ‰è®²è¿‡çš„ç¤ºä¾‹ä»£ç ï¼Œæœ¬å°èŠ‚ä¸­æ‰€æœ‰çš„ä»£ç å’Œä¸Šé¢ç¤ºä¾‹ä»£ç æ²¡æœ‰ä»»ä½•å…³è”ã€‚\nç›®å‰æ— æ³•ä½¿ç”¨OrbitControlsçš„å›°å¢ƒ åœ¨ä»¥å‰æ‰€æœ‰çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ é•œå¤´è½¨é“æ§åˆ¶å™¨ï¼Œéƒ½æ˜¯ä½¿ç”¨ä»¥ä¸‹ä»£ç ï¼š\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls' const controls = new OrbitControls(camera,canvas) æˆ–è€… const controls = new OrbitControls(camera,window.body) OrbitControls æ„é€ å‡½æ•°ç¬¬ 2 ä¸ªå‚æ•°æ— è®ºæ˜¯ canvas è¿˜æ˜¯ window.bodyï¼Œä¸€å®šæ˜¯ä¸€ä¸ª DOM å…ƒç´ ã€‚\næˆ‘ä»¬å·²ç»å°† Three.js ç›¸å…³ä»£ç éƒ½è½¬ç§»åˆ°äº† Worker å†…éƒ¨ï¼Œä½†æ˜¯Web Worker å†…éƒ¨æ˜¯æ— æ³•è·å– DOM å…ƒç´ çš„ï¼Œé‚£ä¹ˆæ„å‘³ç€ OrbitControls æ ¹æœ¬å°±æ— æ³•åˆå§‹åŒ–ã€‚\nä¸è¦æƒ³ç€å°è¯•å°† DOM å…ƒç´ ä½œä¸º å‚æ•°ï¼Œä½¿ç”¨ .postMessage() å‡½æ•°ä¼ é€’ç»™ Worker å†…éƒ¨ï¼Œå› ä¸º .postMessage() å‡½æ•°ä¸­çš„å‚æ•°å¹¶ä¸æ˜¯ä¼ é€’å¼•ç”¨ï¼Œè€Œæ˜¯ç›´æ¥æ·±åº¦å¤åˆ¶ä¸€ä»½ã€‚\né‚£ä¹ˆç©¶ç«Ÿè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ æˆ‘ä»¬å…ˆç ”ç©¶ä¸€ä¸‹ OrbitControls çš„æºç ï¼š\nhttps://github.com/mrdoob/three.js/blob/dev/examples/jsm/controls/OrbitControls.js\næˆ‘æŠŠæºç ä¸­å’Œ Dom å…ƒç´ ç›¸å…³çš„ä¸€äº›å…³é”®ä»£ç æ‘˜å½•å‡ºæ¥ï¼š\n//è®¾ç½® scope = this var scope = this; var OrbitControls = function ( object, domElement ) { //ä¸‹é¢è¿™è¡Œä»£ç ç›¸å½“äº scope.domElement = domElement this.domElement = domElement; } //æ·»åŠ é¼ æ ‡å³é”®(ä¸Šä¸‹æ–‡)èœå•äº‹ä»¶ä¾¦å¬ scope.domElement.addEventListener( 'contextmenu', onContextMenu); //æ·»åŠ è§¦æ§ç¬”å’Œé¼ æ ‡æ‘ä¸‹äº‹ä»¶ä¾¦å¬ scope.domElement.addEventListener( 'pointerdown', onPointerDown); //æ·»åŠ é¼ æ ‡æ»šè½´äº‹ä»¶ä¾¦å¬ scope.domElement.addEventListener( 'wheel', onMouseWheel ); //æ·»åŠ è§¦æ‘¸å¼€å§‹ã€ç»“æŸã€ç§»åŠ¨äº‹ä»¶ä¾¦å¬ scope.domElement.addEventListener( 'touchstart', onTouchStart); scope.domElement.addEventListener( 'touchend', onTouchEnd); scope.domElement.addEventListener( 'touchmove', onTouchMove); //æ·»åŠ é”®ç›˜äº‹ä»¶ä¾¦å¬ scope.domElement.addEventListener( 'keydown', onKeyDown); if ( state !== STATE.NONE ) { //æ·»åŠ è§¦æ§ç¬”å’Œé¼ æ ‡ç§»åŠ¨äº‹ä»¶ä¾¦å¬ scope.domElement.ownerDocument.addEventListener( 'pointermove', onPointerMove, false ); //æ·»åŠ è§¦æ§ç¬”å’Œé¼ æ ‡æ¾å¼€äº‹ä»¶ä¾¦å¬ scope.domElement.ownerDocument.addEventListener( 'pointerup', onPointerUp, false ); scope.dispatchEvent( startEvent ); } è¡¥å……è¯´æ˜ï¼šåœ¨æœ€æ–°çš„æµè§ˆå™¨äº‹ä»¶ä¸­ pointer ç›¸å…³äº‹ä»¶å³åŒ…å«è§¦æ§ç¬”ï¼Œä¹ŸåŒ…å«é¼ æ ‡ã€‚æ‰€ä»¥ pointerdownã€pointermoveã€pointerup è¿™ 3 ä¸ªäº‹ä»¶å¯¹åº” è§¦æ§ç¬”æˆ–é¼ æ ‡ å¯¹åº”çš„äº‹ä»¶ï¼Œç›¸å½“äºæ˜¯ 2 è€…çš„åˆä½“ã€‚\nä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬åˆå§‹åŒ–ä¼ é€’ç»™ OrbitControls çš„ DOM å…ƒç´ ä¸»è¦æ˜¯ç”¨æ¥æ·»åŠ å„ç§äº‹ä»¶ä¾¦å¬ã€‚\nå½“ç„¶ OrbitControls ä»£ç ä¸­ä¹Ÿæœ‰å¯¹åº”çš„ removeEventListener ç§»é™¤äº‹ä»¶ä¾¦å¬ã€‚\nè¡¥å……ä¸€ç‚¹ï¼šcontextmenu äº‹ä»¶è™½ç„¶ç›®å‰éƒ¨åˆ†æµè§ˆå™¨æ”¯æŒ(ä¸»è¦æ˜¯ç«ç‹æµè§ˆå™¨)ï¼Œä½†æ˜¯åœ¨ MDN çš„æ–‡æ¡£ä¸­å·²ç»æ˜ç¡®è¯¥äº‹ä»¶å³å°†è¢«åºŸé™¤ã€‚\né‡ç‚¹æ¥äº†ï¼Œè¯·å¬å¥½ï¼š\næ—¢ç„¶ OrbitControls éœ€è¦ DOM å…ƒç´ çš„ç›®çš„æ˜¯ä¸ºäº†è·å–å¹¶æ·»åŠ å„ç§äº‹ä»¶ä¾¦å¬\nè€Œ Worker ä¸­æ— æ³•è·å– DOM å…ƒç´ \né‚£ä¹ˆæœ‰æ²¡æœ‰å¯èƒ½æˆ‘ä»¬è™šæ‹Ÿå‡ºæ¥ä¸€ä¸ªå¯¹è±¡ï¼Œè®©è¯¥å¯¹è±¡æ‹¥æœ‰å’Œ DOM å…ƒç´ ç›¸åŒçš„äº‹ä»¶ API\næ¢å¥è¯è¯´ï¼Œå°±æ˜¯è®©è¿™ä¸ªè™šæ‹Ÿå‡ºæ¥çš„å¯¹è±¡å…·å¤‡æŠ›å‡ºäº‹ä»¶çš„èƒ½åŠ›\nè¡¥å……ä¸€ç‚¹ï¼Œè¿™é‡Œè¯´çš„ DOM äº‹ä»¶å…¶å®æœ‰ 2 ç§ï¼š\nDOM å…ƒç´ ä¸Šçš„å„ç§ç”¨æˆ·äº¤äº’ 5 ç§äº‹ä»¶ï¼šé¼ æ ‡äº‹ä»¶ã€æ»šè½´äº‹ä»¶ã€é”®ç›˜äº‹ä»¶ã€è§¦æ‘¸äº‹ä»¶ã€å³é”®èœå•äº‹ä»¶ æµè§ˆå™¨çª—å£å°ºå¯¸å‘ç”Ÿå˜åŒ–å¼•å‘ DOM å…ƒç´ å°ºå¯¸å‘ç”Ÿå˜åŒ–çš„ window resize äº‹ä»¶ æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯åˆ†åˆ«æ¨¡æ‹Ÿå‡ºä»¥ä¸Š 6 ç§äº‹ä»¶ ç„¶åæˆ‘ä»¬è®© OrbitControls å»ä¾¦å¬è¿™ä¸ªè™šæ‹Ÿå¯¹è±¡æ‰€å‘å‡ºçš„å„ç§äº‹ä»¶\nä¹Ÿå°±æ˜¯è¯´è®©è¿™ä¸ªè™šæ‹Ÿå¯¹è±¡ä»£æ›¿çœŸå®çš„ DOM å…ƒç´ ï¼Œä»¥æ­¤æ¥è§£å†³æˆ‘ä»¬ç›®å‰çš„å›°å¢ƒ\næ€è·¯æœ‰äº†ï¼Œé‚£è¯¥å…·ä½“æ€ä¹ˆåšå‘¢ï¼Ÿ\né¦–å…ˆæˆ‘ä»¬è¦æ˜ç™½ä¸€ä»¶äº‹ï¼ŒåŸç”Ÿ DOM å¯¹åº”çš„å±æ€§ã€æ–¹æ³•ã€äº‹ä»¶ã€ä»¥åŠäº‹ä»¶æºå¸¦çš„å±æ€§ ç§ç±»ç¹å¤šä¸”å¤æ‚ã€‚\nè€Œ OrbitControls å¹¶ä¸æ˜¯æ¯ä¸€ä¸ªå±æ€§ã€æ–¹æ³•ã€äº‹ä»¶ã€äº‹ä»¶æ¯ä¸€ä¸ªå±æ€§ éƒ½ä½¿ç”¨åˆ°äº†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ‰€è°“çš„ â€œæ¨¡æ‹Ÿâ€ä¸éœ€è¦ 100% ä¸€æ¨¡ä¸€æ ·ï¼Œæˆ‘ä»¬åªéœ€è¦æä¾› OrbitControls éœ€è¦çš„å³å¯ã€‚\nç©¶ç«Ÿéœ€è¦æ¨¡æ‹Ÿå‡º DOM å…ƒç´ å“ªäº›å±æ€§å’Œæ–¹æ³•ï¼Œæˆ‘ä»¬ä¼šåœ¨å…·ä½“ä»£ç æ—¶è®²è§£ã€‚\næ­¤åˆ»ï¼Œæˆ‘ä»¬åªä»¥äº‹ä»¶æºå¸¦çš„å±æ€§æ¥ä¸¾ä¾‹è¯´æ˜ï¼š\nå¯¹äºé¼ æ ‡æ»šè½´æ»šåŠ¨æ¥è¯´ï¼ŒOrbitControls åªéœ€è¦ä½¿ç”¨åˆ°è¯¥äº‹ä»¶çš„ deltaY å€¼\nå¯¹äºé”®ç›˜äº‹ä»¶æ¥è¯´ï¼ŒOrbitControls åªéœ€è¦ä½¿ç”¨åˆ°è¯¥äº‹ä»¶çš„ ctrlKeyã€metaKeyã€shiftKeyã€keyCode å€¼\nmeta é”®ï¼Ÿ\nè¿™ä¸ª meta é”®åœ¨ Windows é”®ç›˜ä¸Šç›¸å½“äº windows é”®ã€åœ¨è‹¹æœé”®ç›˜ä¸Šæ˜¯ä¸€ä¸ªå››ç“£çš„å°èŠ±ã€‚\nåœ¨ OrbitControls å†…éƒ¨å¹¶æœªä½¿ç”¨åˆ° altKey å€¼\næ³¨æ„ï¼šç”±äº OrbitControls ä»…ä½¿ç”¨åˆ°é”®ç›˜ ä¸Š/ä¸‹/å·¦/å³ 4 ä¸ªé”®ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä¸»åŠ¨è¿‡æ»¤æ‰ä¸€äº›æ— ç”¨çš„æ‘é”®ï¼Œæ¢å¥è¯è¯´ä¹Ÿå°±æ˜¯æå‰åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æ˜¯ä»¥ä¸Š 4 ä¸ªæ–¹å‘é”®ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç›´æ¥è·³è¿‡ï¼Œä¸ä¼ é€’è¯¥äº‹ä»¶\næ³¨æ„ï¼šå¯¹äºç›®å‰ç‰ˆæœ¬ Three.js r126 ç‰ˆæœ¬è€Œè¨€ï¼ŒOrbitControls é”®ç›˜äº‹ä»¶è¯»å–ä½¿ç”¨çš„æ˜¯ keyCodeï¼Œä½†æ˜¯ event.keyCode äº‹å®ä¸Šå·²ç»ä¸è¢«æ¨èä½¿ç”¨ï¼Œå»ºè®®ä½¿ç”¨ event.code å±æ€§ã€‚\næ‰€ä»¥æˆ‘é¡ºå¸¦å‘ Three.js å®˜æ–¹æäº¤äº† PRï¼Œå°† keyCode ä¿®æ”¹ä¸º codeï¼Œè¿™ä¸ª PR å·²ç»è¢«å®˜æ–¹å®¡æŸ¥é€šè¿‡äº†ï¼Œä¼šåœ¨ r127 ç‰ˆæœ¬ä¸­ä½¿ç”¨ã€‚å› æ­¤ï¼Œæˆ‘ä¹Ÿæˆä¸º Three.js ä»£ç è´¡çŒ®è€…äº†ã€‚\næˆ‘æäº¤çš„è¿™ä¸ª PRï¼šhttps://github.com/mrdoob/three.js/pull/21409\nå…³äºä¸ºä»€ä¹ˆä¸å†æ¨èä½¿ç”¨ event.keyCode ä¸»è¦æ˜¯å› ä¸º keyCode ä¸èƒ½å¤Ÿæ¯”è¾ƒæ¸…æ™°æ­£ç¡®è¿”å›é”®ç›˜æ‰€æ‘é”®ï¼Œä¾‹å¦‚ å†’å·å’Œåˆ†å· éƒ½æ˜¯åŒä¸€ä¸ªé”®ï¼Œæ­¤æ—¶ keyCode å°±æ— æ³•ç²¾ç¡®åŒºåˆ†ã€‚\nå¯¹äºé¼ æ ‡äº‹ä»¶ï¼ŒOrbitControls éœ€è¦ä½¿ç”¨åˆ°è¯¥äº‹ä»¶çš„ pointerTypeã€buttonã€clientXã€clientYã€ctrlKeyã€metaKeyã€shiftKey å€¼\nå¯¹äºè§¦æ‘¸(touch)äº‹ä»¶ï¼ŒOrbitControls éœ€è¦ä½¿ç”¨æ¯ä¸€ä¸ª è§¦æ‘¸ç‚¹çš„ pageXã€pageY å±æ€§å€¼\nâ€¦\næˆ‘ä»¬éœ€è¦è®© â€œè™šæ‹Ÿå¯¹è±¡â€ æŠ›å‡º â€œè™šæ‹Ÿäº‹ä»¶â€ï¼Œå¹¶ä¸”è™šæ‹Ÿäº‹ä»¶æ‹¥æœ‰ä¸Šé¢é‚£äº›å±æ€§å€¼ã€‚\nè¡¥å……è¯´æ˜ï¼šè¿™é‡Œæ‰€è¯´çš„ â€œæŠ›å‡ºäº‹ä»¶â€ æš—å« 2 ç§äº‹ä»¶ï¼š\nç”¨æˆ·äº¤äº’äº‹ä»¶ï¼šé¼ æ ‡äº‹ä»¶ã€æ»šè½´äº‹ä»¶ã€é”®ç›˜äº‹ä»¶â€¦\næµè§ˆå™¨çª—å£å˜åŒ–å¼•å‘ â€œDOM å…ƒç´ â€ å†…éƒ¨å°ºå¯¸å±æ€§ç›¸å…³çš„ä¿®æ”¹äº‹ä»¶\né™¤äº† window æ‹¥æœ‰ resize äº‹ä»¶ä¹‹å¤–ï¼Œæ™®é€š DOM å…ƒç´ æ˜¯ä¸å…·å¤‡ resize äº‹ä»¶çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªåŸæœ¬ä¸å­˜åœ¨çš„ DOM å…ƒç´  resize è¿½åŠ åˆ° æˆ‘ä»¬çš„æ¶ˆæ¯ä¸­ï¼Œå¯¹äº ç”¨æˆ·äº¤äº’äº‹ä»¶ æˆ‘ä»¬é€‰æ‹©ç›´æ¥æŠ›å‡ºã€å¯¹äº window resize å¼•å‘çš„å°ºå¯¸ä¿®æ”¹äº‹ä»¶ï¼Œæˆ‘ä»¬é€‰æ‹©å†…éƒ¨ç›´æ¥å¤„ç†ã€‚\nå±æ€§è¡¥å……è¯´æ˜ï¼š\nåœ¨ OrbitControls å†…éƒ¨ï¼Œè¿˜ä¼šå¯¹ç›‘å¬çš„ DOM å…ƒç´ çš„æ ¹å…ƒç´ æ·»åŠ  2 ä¸ªäº‹ä»¶ä¾¦å¬ã€‚\n// scope = this scope.domElement.ownerDocument.addEventListener( 'pointermove', onPointerMove ); scope.domElement.ownerDocument.addEventListener( 'pointerup', onPointerUp ); å› æ­¤æˆ‘ä»¬æ¨¡æ‹Ÿçš„å…ƒç´ è¿˜è¦æ‹¥æœ‰ .ownerDocument å±æ€§å€¼ã€‚\nåœ¨åé¢çš„å®é™…ä»£ç ä¸­ä½ ä¼šçœ‹åˆ°ï¼Œæˆ‘ä»¬ä¼šè®© æ¨¡æ‹Ÿå…ƒç´  .ownerDocument æŒ‡å‘è‡ªèº«ã€‚\nthis.ownerDocument = this\ndocumentè¡¥å……è¯´æ˜ï¼š\nåœ¨ OrbitControls ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œæœ‰ä»¥ä¸‹ä»£ç ï¼š\nif ( domElement === undefined ) console.warn( 'THREE.OrbitControls: The second parameter \"domElement\" is now mandatory.' ); if ( domElement === document ) console.error( 'THREE.OrbitControls: \"document\" should not be used as the target \"domElement\". Please use \"renderer.domElement\" instead.' ); ä¹Ÿå°±æ˜¯è¯´åœ¨åˆå§‹åŒ– OrbitControls æ—¶ä¼šå¯¹è¦ä¾¦å¬çš„ DOM å…ƒç´ è¿›è¡Œæ£€æŸ¥ã€‚åœ¨ç¬¬ 2 è¡Œä»£ç ä¸­éœ€è¦ä½¿ç”¨åˆ° document è¿™ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯åœ¨ web worker ä¸­æ ¹æœ¬æ— æ³•è®¿é—® documentï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»™ worker æ·»åŠ ä¸€ä¸ª document å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š\n//@ts-ignore self.document = {} æ·»åŠ  //@ts-ignore è¿™æ ·æ³¨é‡Šï¼Œå¯ä»¥è®© TypeScript å¿½ç•¥ä¸‹é¢ä¸€è¡Œä»£ç çš„æ£€æŸ¥ã€‚\nå› ä¸º window.document åœ¨ TS ç‰ˆæœ¬é‡Œè¢«å®šä¹‰ä¸º åªè¯»å¯¹è±¡ï¼Œæ˜¯æ— æ³•ä¿®æ”¹çš„ã€‚\nå¦‚æœæˆ‘ä»¬ä¸é€‰æ‹©å¿½ç•¥ TS æ£€æŸ¥ï¼Œå½“å»æ‰§è¡Œ self.document = {} æ—¶ TS å°±ä¼šæŠ¥é”™ã€‚\næˆ‘ä»¬æ·»åŠ çš„ self.document = {} çº¯ç²¹æ˜¯ä¸ºäº†è®© OrbitControls æ„é€ å‡½æ•°å¯ä»¥å»è®¿é—®åˆ° document å¯¹è±¡ï¼Œé¿å…æŠ¥é”™ã€‚\næ‰€è°“çš„ â€œæŠ›å‡ºäº‹ä»¶â€ å®ç°çš„é€”å¾„æ˜¯ç”± æˆ‘ä»¬è™šæ„å‡ºçš„ä¸€ä¸ª äº‹ä»¶æ´¾å‘å™¨ æ¥å®ç°çš„ã€‚\nè¯¥äº‹ä»¶æ´¾å‘å™¨çš„ 3 ä¸ªåŠŸèƒ½è´£ä»»ï¼š\nç›‘å¬åŠŸèƒ½ï¼šç›‘å¬çœŸå®DOMå…ƒç´ äº‹ä»¶ï¼šç”¨æˆ·äº¤äº’äº‹ä»¶ã€æµè§ˆå™¨å°ºå¯¸å˜åŒ–äº‹ä»¶ äº‹ä»¶è½¬åŒ–ï¼šå°†ç›‘å¬åˆ°çš„äº‹ä»¶å†…å®¹ï¼Œè½¬åŒ–ä¸ºä¸€æ¡æ•°æ®ï¼Œè¯¥æ•°æ®åŒ…å«è¯¥äº‹ä»¶ä¸­ OrbitControls æ‰€éœ€è¦çš„å„ç§å±æ€§å€¼ æ¶ˆæ¯ä¼ é€’ï¼šå°†äº‹ä»¶è½¬åŒ–åçš„æ•°æ®ï¼Œé€šè¿‡ web worker çš„ postMessage() ä¼ é€’ç»™ web worker æ‰€è°“çš„â€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€ï¼Œä¹Ÿå°±æ˜¯åœ¨ web worker ä¸­å·¥ä½œçš„ DOM å…ƒç´ ã€‚\nè¯¥â€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€çš„ 2 ä¸ªåŠŸèƒ½è´£ä»»ï¼š\næ¨¡æ‹Ÿ DOM å…ƒç´ çš„å±æ€§å’Œæ–¹æ³• å¤„ç† DOM å…ƒç´ éœ€è¦å¤„ç†çš„å„ç§äº‹ä»¶ è¯¥â€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€çš„ç”Ÿå‘½å·¥ä½œæµç¨‹ä¸ºï¼š\nindex.tsx ä¸­æ·»åŠ å¯¹ çœŸå® DOM å…ƒç´ çš„ç›‘å¬ï¼Œå¹¶ä¸”é€šçŸ¥ worker åˆ›å»ºâ€œæ¨¡æ‹Ÿå…ƒç´ â€çš„æ¶ˆæ¯\nworker.ts ä¸­æ¥æ”¶æ¶ˆæ¯ï¼Œå¼€å§‹åˆ›å»ºä¸€ä¸ª â€œæ¨¡æ‹Ÿå…ƒç´ â€ï¼Œå¹¶ä¸”æŠŠè¯¥å…ƒç´ ä¼ é€’ç»™ OrbitControls\nindex.tsx ä¸­ç›‘å¬åˆ°çœŸå® DOM å…ƒç´ è§¦å‘çš„å„ç§äº‹ä»¶ï¼Œå°†è¯¥äº‹ä»¶åˆ†æå¤„ç†ï¼Œè½¬åŒ–ä¸ºä¸€æ¡çº¦å®šå¥½çš„æ¶ˆæ¯ å¹¶å‘é€ç»™ worker\nworker.ts ä¸­æ¥æ”¶åˆ°äº‹ä»¶æ¶ˆæ¯åï¼Œå°†è¯¥æ¶ˆæ¯è½¬å‘ç»™ â€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€\nâ€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€ æ¥æ”¶è¯¥æ¶ˆæ¯ï¼Œç„¶åå°†è¯¥æ¶ˆæ¯(åŒ…å«äº‹ä»¶ç±»å‹ã€äº‹ä»¶å±æ€§)æŠ›å‡ºï¼Œä¾› OrbitControls ä½¿ç”¨\næˆ‘ä»¬æŠ›å‡ºçš„äº‹ä»¶ï¼Œä¹Ÿæ˜¯æ¨¡æ‹Ÿå‡ºæ¥çš„äº‹ä»¶ï¼Œå¹¶ä¸æ˜¯åŸå§‹ DOM äº‹ä»¶ï¼Œåªä¸è¿‡æˆ‘ä»¬æ¨¡æ‹Ÿå‡ºæ¥çš„äº‹ä»¶ä¸­æ°å¥½åŒ…å« OrbitControls éœ€è¦çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ã€‚\nåœ¨ web worker ä¸­å·¥ä½œçš„ OrbitControlsï¼Œä»å§‹è‡³ç»ˆéƒ½ä¸çŸ¥é“è‡ªå·±æ“ä½œçš„å…¶å®æ˜¯ä¸€ä¸ªå‡çš„ DOM å…ƒç´ ï¼Œä»¥åŠç›‘å¬çš„äº‹ä»¶ä¹Ÿæ˜¯å‡çš„ DOM äº‹ä»¶ã€‚\næ•´ä¸ªäº‹ä»¶çš„æµç¨‹ä¸ºï¼š\nçœŸå®DOMäº‹ä»¶ \u003e è½¬åŒ–ä¸ºæ¶ˆæ¯ \u003e å‘é€ç»™ worker \u003e ä¼ é€’ç»™â€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€ \u003e æŠ›å‡ºè¯¥æ¶ˆæ¯(ç›¸å½“äºæŠ›å‡ºè¯¥äº‹ä»¶)\né€šè¿‡ äº‹ä»¶ \u003e æ¶ˆæ¯ \u003e æ¶ˆæ¯ \u003e äº‹ä»¶ è¿™æ ·ä¸€æ³¢æ“ä½œè¿‡åï¼Œå¯ä»¥è®© OrbitControls å°±åƒç›‘æ§çœŸå® DOM å…ƒç´ ä¸€æ ·ç›‘æ§è¿è¡Œåœ¨ web worker ä¸­çš„é‚£ä¸ª â€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€ã€‚\næˆ‘æ•…æ„ä¸€ç›´ä½¿ç”¨ â€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€è¿™ä¸ªè¯ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨ â€œè™šæ‹ŸDOMâ€ï¼Œå°±æ˜¯ä¸ºäº†è®©æˆ‘ä»¬é¿å…å’Œ react ä¸­ è™šæ‹ŸDOM çš„ä¸€è¯å¼„æ··æ·†ã€‚\nå…³äº äº‹ä»¶æŠ›å‡º çš„è¡¥å……è¯´æ˜ï¼š\næˆ‘ä»¬è®© â€œè™šæ„å…ƒç´ â€ ç»§æ‰¿äº Three å·²å†…ç½®çš„ EventDispatcherï¼Œè¿™æ · â€œè™šæ„å…ƒç´ â€ å°± å…·å¤‡ .dispatcheEvent() æ–¹æ³•ã€‚\nimport { EventDispatcher } from 'three' ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ åŸç”Ÿ JS æä¾›çš„ EventTarget ï¼Ÿ\nè¿™æ˜¯å› ä¸ºåŸç”Ÿ JS æä¾›çš„ EventTarget è™½ç„¶ä¹Ÿæœ‰ .dispatcheEvent()ï¼Œä½†é—®é¢˜æ˜¯å®ƒåªå¯ä»¥æŠ›å‡º JS ä¸­çš„ Event å®ä¾‹ï¼Œè€Œæˆ‘ä»¬åœ¨ worker ä¸­å¹¶ä¸èƒ½ä½¿ç”¨ Eventã€‚\nè¡¥å……è¯´æ˜ï¼š\næ— è®º JS åŸç”Ÿçš„ EventTargetï¼Œè¿˜æ˜¯ Three.js å†…ç½®çš„ EventDispatcherï¼Œä»–ä»¬å†…éƒ¨æœ¬è´¨ä¸Šéƒ½æ˜¯æ‰§è¡Œçš„æ˜¯å‡½æ•°è°ƒç”¨ï¼Œæ‰€ä»¥ä»–ä»¬çš„æ‰§è¡Œè¿‡ç¨‹éƒ½æ˜¯ åŒæ­¥çš„ã€‚\næµè§ˆå™¨ä¸­åŸç”Ÿçš„å„ç§äº‹ä»¶å¤„ç†å‡½æ•° å…¶å®æ˜¯å¼‚æ­¥çš„ã€‚\næ•´ä½“è§£å†³æ€è·¯å›é¡¾ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥å®ç°ï¼Ÿ\nå›é¡¾ä¸€ä¸‹æœ¬å°èŠ‚å¼€å¤´çš„å›°å¢ƒé—®é¢˜ï¼šweb worker æœ¬èº«ä¸å¯ä»¥è®¿é—®çœŸå® DOM å…ƒç´ ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬ DOM äº‹ä»¶ã€‚\né‚£ä¹ˆæˆ‘ä»¬ç©¶ç«Ÿæ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿä»¥åŠä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥åšåˆ°ï¼Ÿ\nç­”ï¼šæœºç¼˜å·§åˆ\n**ç¬¬1ç§æœºç¼˜å·§åˆï¼š**è™½ç„¶ web worker æ— æ³•è®¿é—®çœŸå®çš„ DOM å…ƒç´ ï¼Œä½†æ˜¯ canvas å…ƒç´ å¯¹åº”çš„ OffscreenCanvas å´æ˜¯ä¸€ä¸ªä¾‹å¤–ï¼Œé€šè¿‡ä¸»çº¿ç¨‹è®©å‡º canvas ç»˜åˆ¶æ§åˆ¶æƒï¼Œè®© web worker æ‹¥æœ‰äº†å¯ä»¥æ“ä½œå¹¶ç»˜åˆ¶ canvas å…ƒç´ çš„èƒ½åŠ›ã€‚\nç›®å‰ç«ç‹æµè§ˆå™¨å¹¶ä¸æ”¯æŒ OffscreenCanvasï¼Œæ‰€ä»¥æœ¬ç¤ºä¾‹è¿˜è¦è€ƒè™‘åœ¨é worker æƒ…å†µä¸‹çš„åœºæ™¯åˆ›å»ºã€‚\n**ç¬¬2ç§æœºç¼˜å·§åˆï¼š**è™½ç„¶ web worker æ— æ³•ç›´æ¥ç›‘å¬çœŸå® DOM å…ƒç´ äº‹ä»¶ï¼Œä½†æ˜¯ web worker å†…éƒ¨å´å¯ä»¥è¿è¡Œ æŠ›å‡ºäº‹ä»¶ è¿™ä¸ªæ“ä½œã€‚äºæ˜¯æˆ‘ä»¬é€šè¿‡ äº‹ä»¶ \u003e æ¶ˆæ¯ \u003e æ¶ˆæ¯ \u003e äº‹ä»¶ çš„æ“ä½œè®© web worker å†…éƒ¨æ¨¡æ‹Ÿå‡ºçš„ DOM å…ƒç´ æ‹¥æœ‰äº†åƒçœŸå® DOM å…ƒç´ ä¸€æ ·çš„å„ç§äº‹ä»¶æŠ›å‡ºæœºåˆ¶ã€‚\nå†æ¬¡æé†’ä¸€ä¸‹ï¼šåœ¨ web worker ä¸­ï¼Œä¸å…‰ DOM å…ƒç´ æ˜¯æˆ‘ä»¬æ¨¡æ‹Ÿå‡ºæ¥çš„ï¼Œå°±è¿æŠ›å‡ºçš„ DOM å…ƒç´ äº‹ä»¶ä¹Ÿæ˜¯æˆ‘ä»¬æ¨¡æ‹Ÿå‡ºæ¥çš„ã€‚\næœ€ç»ˆæˆ‘ä»¬è®© web worker ä¸­ OrbitControls æ­£å¸¸è¿è¡Œèµ·æ¥äº†ã€‚\nå¦‚æœä½ å¯¹æˆ‘ä¸Šé¢çš„è®²è¿°è¿˜ä¸å¤ªç†è§£ï¼Œé‚£ä¹ˆå¤šè¯»å‡ éï¼Œä¸è¦ç€æ€¥æ¥ç€å¾€ä¸‹çœ‹ã€‚å› ä¸ºå¦‚æœæ•´ä½“çš„æ€è·¯ä½ æ²¡æœ‰ç†è§£é€ï¼Œé‚£ä¹ˆä¸‹é¢è¿™äº›å…·ä½“å®ç°çš„ä»£ç ï¼Œé˜…è¯»èµ·æ¥ä¹Ÿä¼šä¸€å¤´é›¾æ°´ã€‚\nå®è¯å®è¯´ï¼Œåœ¨å­¦ä¹ æœ¬ç« å†…å®¹ï¼Œçœ‹è‹±æ–‡åŸç‰ˆæ•™ç¨‹ï¼Œæˆ‘èŠ±äº†å°†è¿‘ä¸€å‘¨çš„æ—¶é—´ï¼Œæ‰å¼„æ˜ç™½æ•´ä¸ªåŸç†ã€‚\næœ¬æ–‡è®²çš„å†…å®¹å¯èƒ½æ˜¯æ•´ä¸ª three.js æ•™ç¨‹ä¸­æœ€ç»•ã€æœ€å¤æ‚çš„ï¼Œä½†æ˜¯ä¸ºäº†æ€§èƒ½ä¼˜åŒ–ï¼Œå­¦ä¹ ä¸€ä¸‹æ˜¯éå¸¸å€¼å¾—çš„ã€‚\nè¡¥å……ä¸€ä¸ªå’Œæœ¬æ–‡æ— å…³çš„çŸ¥è¯†ç‚¹ï¼š\né™¤äº† window ä¹‹å¤–ï¼Œå…¶ä»– DOM å…ƒç´ å°ºå¯¸å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ˜¯ä¸ä¼šè§¦å‘ä»»ä½•äº‹ä»¶çš„ã€‚\né€šè¿‡ css ä¿®æ”¹ DOMå…ƒç´ å°ºå¯¸ å› ä¸º window resize äº‹ä»¶è€Œä¿®æ”¹ DOM å…ƒç´ å°ºå¯¸ å¦‚æœä½ æƒ³ç›‘å¬æŸ DOM å…ƒç´ å°ºå¯¸çš„å˜åŒ–ï¼Œåœ¨æœ€æ–°çš„ DOM3 æ ‡å‡†ä¸­ï¼Œå¯ä»¥é€šè¿‡ MutationObserver æ¥ç›‘æ§ï¼Œå…·ä½“ç”¨æ³•è¯·æŸ¥é˜… MDN å®˜æ–¹æ–‡æ¡£ã€‚\nhttps://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver\næ•´ä½“æ€è·¯ç¤ºæ„å›¾ æ¥ä¸‹æ¥å¼€å§‹è®²è§£å…·ä½“ä»£ç å¦‚ä½•å®ç°ã€‚\nç”±äºæˆ‘ä½¿ç”¨çš„æ˜¯ React + TypeScriptï¼ŒåŠ ä¸Šæˆ‘æœ‰ä¸€äº›è‡ªå·±ä»£ç ç†è§£å’Œåˆ’åˆ†ï¼Œæ‰€ä»¥æˆ‘ä¸‹é¢è®²è¿°çš„ä»£ç å’ŒåŸæ•™ç¨‹å¾ˆå¤šåœ°æ–¹éƒ½ä¸ä¸€æ ·ã€‚\nè¿‡ç¨‹æœ‰ç‚¹å¤æ‚ï¼Œå¸Œæœ›æˆ‘èƒ½è®²æ¸…æ¥šã€‚\nä»£ç æ¨¡å—è§„åˆ’ å®šä¹‰ä¸€ä¸ªç±» FictionalElement ç»§æ‰¿äº EventDispatcherï¼Œç”¨è¿™ä¸ªç±»çš„å®ä¾‹æ¥æ¨¡æ‹Ÿ â€œDOMå…ƒç´ æœ¬èº«â€\nè¯·æ³¨æ„ï¼šFictionalElement åªå…·å¤‡(æ¨¡ä»¿ã€æ¨¡æ‹Ÿ) â€œDOMå…ƒç´ â€ æœ¬èº«çš„ä¸€äº›å±æ€§å’Œæ–¹æ³•(ä¾‹å¦‚ widthã€heightã€leftã€topã€getBoundingClientRect() ç­‰)ï¼Œä½†å¹¶ä¸å…·å¤‡å¯ä»¥ç›´æ¥å’Œ web worker é€šä¿¡çš„èƒ½åŠ›\nåœ¨æ¨¡æ‹Ÿä¸€äº› â€œæ— ç”¨â€ çš„æ–¹æ³•æ—¶ï¼Œä¾‹å¦‚ focus()ã€preventDefault()ã€stopPropagation()ï¼Œå°†è¯¥æ–¹æ³•ä»£ç ä½“å†…ä¸æ·»åŠ ä»»ä½•ä»£ç ï¼Œåªæ˜¯ä¿è¯æœ‰è¿™ä¸ªæ–¹æ³•ä½†æ— éœ€æœ‰å®é™…æ‰§è¡Œå†…å®¹ã€‚\nå®šä¹‰ä¸€ä¸ªç±» FictionalElementManager ç”¨æ¥åˆ›å»ºå’Œç®¡ç†æ‰€æœ‰ FictionalElement å®ä¾‹\näº‹å®ä¸Šæˆ‘è®¤ä¸ºè¿™ä¸€æ­¥éª¤ä¸æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºå®é™…é¡¹ç›®ä¸­ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹ç½‘é¡µä¸­éƒ½åªä¼šæœ‰ä¸€ä¸ª ç”¨æˆ·äº¤äº’å…ƒç´ (é€šå¸¸ä¸º canvas æˆ– document.body)ï¼Œå¹¶ä¸ä¼šæœ‰å¤ªå¤šå…ƒç´ éœ€è¦æˆ‘ä»¬ç®¡ç†ã€‚ä½†æ˜¯æœ¬æ–‡å¯¹åº”çš„ åŸç‰ˆæ•™ç¨‹ ä¸­æœ‰è¿™ä¸€ç¯èŠ‚(ç®¡ç†å±‚)ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿç»§ç»­éµå¾ªã€‚\nä¸ºäº†åŒºåˆ«ä¸åŒçš„ç®¡ç†å¯¹è±¡ï¼Œæˆ‘ä»¬å°†åœ¨å†…éƒ¨ç»™æ¯ä¸€ä¸ª ElementProxyReceiver æ·»åŠ ä¸€ä¸ªå¯¹åº”çš„ id\nåŸç‰ˆæ•™ç¨‹ä¸­ï¼Œid æ˜¯ç”± FictionalElementManager æä¾›çš„ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºè¿™æ ·å¹¶ä¸åˆç†ï¼Œæˆ‘é‡‡ç”¨çš„æ˜¯é€šè¿‡å¤–éƒ¨ä¼ é€’ id ä¸º string ç±»å‹çš„å€¼ã€‚\nå®šä¹‰ä¸€ä¸ªç±» FictionalWindow ç”¨æ¥æ¨¡æ‹Ÿ window\nè¯·æ³¨æ„ï¼Œç›®å‰æ¥è¯´ FictionalWindow ä»…ä»…æ˜¯ç»§æ‰¿äº† EventDispatcherï¼Œå¹¶æ²¡æœ‰åšå…¶ä»–è®¾ç½®ï¼Œå…ˆè¿™æ ·åšï¼Œä¹Ÿè®¸æœªæ¥æœ‰å…¶ä»–éœ€æ±‚äº†ï¼Œå†æ ¹æ®éœ€è¦æ‰©å±•å®ƒã€‚\nå®šä¹‰ä¸€ä¸ªç±» ControlsProxy ç”¨æ¥è´Ÿè´£åŸºç¡€çš„ çœŸå®DOMå…ƒç´ ä¸ Web Worker ä¹‹é—´é€šä¿¡ã€‚\nå½“æµè§ˆå™¨çª—å£å°ºå¯¸å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿçš„ â€œDOMå…ƒç´ æœ¬èº«\"ä¹Ÿåº”è¯¥ä¼šå‘ç”Ÿå°ºå¯¸å˜åŒ–ï¼Œè€Œè¿™ä¸ªå˜åŒ–çš„è§¦å‘å¹¶ä¸æ˜¯ç”± FictionalElement å®Œæˆçš„ï¼Œè€Œæ˜¯ç”± ControlsProxy æ¥å®Œæˆçš„ã€‚\nå®šä¹‰ä¸€ä¸ªç±» OrbitControlsProxy ç»§æ‰¿äº ControlsProxyï¼Œç„¶åé‡å†™ configEventListener() å’Œ dispose()\nä½ å¯èƒ½ç–‘æƒ‘ä¸ºä»€ä¹ˆæˆ‘æ²¡æœ‰ç›´æ¥æŠŠä»£ç å†™åœ¨åŒä¸€ä¸ªç±»é‡Œï¼Œè€Œæ˜¯è¦æ‹†åˆ†æˆ 2 ä¸ªã€‚æˆ‘è¿™æ ·åšçš„åŸå› æ˜¯æƒ³å°†ä¸€äº›åŸºç¡€çš„ã€å…±æ€§çš„å±æ€§å’Œæ–¹æ³•æŠ½ç¦»å‡ºæ¥ï¼Œè¿™æ ·æœªæ¥æœ‰ä¸€å¤©æˆ‘ä»¬è¦å»å®ç°å…¶ä»–è½¨é“æ§åˆ¶å™¨ï¼Œéƒ½å¯ä»¥ç»§æ‰¿äº ControlsProxy\nå®šä¹‰ä¸€ä¸ªç±» WorkerMessageTypeï¼Œç”¨æ¥å®šä¹‰ å‘é€æ¶ˆæ¯ çš„ç±»å‹\næ¯æ¬¡éƒ½é æ‰‹å†™æ¶ˆæ¯ç±»å‹æ˜¯ä¸é è°±çš„ï¼Œä¸‡ä¸€æ‰‹æŠ–æ‹¼å†™é”™å­—æ¯äº†æƒ³æ£€æŸ¥å‡ºæ¥éƒ½ä¸å®¹æ˜“ã€‚\næ­¤å¤–ï¼Œè™½ç„¶æœ¬æ•™ç¨‹ä¸€ç›´éƒ½æ˜¯ç”¨çš„æ˜¯ TypeScriptï¼Œä½†æ˜¯åœ¨ç¼–å†™è¿™äº›ç±»çš„æ—¶å€™ï¼Œè€ƒè™‘æœ‰äº›äººå¹¶ä¸ä½¿ç”¨ TSï¼Œæ‰€ä»¥æˆ‘é‡‡ç”¨çš„æ˜¯ .js + JSDoc çš„æ–¹å¼ï¼Œé€šè¿‡ JSDoc ä»£ç æ³¨é‡Šçš„å½¢å¼æ¥å®šä¹‰ä¸åŒæ¶ˆæ¯çš„æ•°æ®ç»“æ„ï¼Œæ²¡æœ‰ä½¿ç”¨ .tsã€‚\næˆ‘ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªç¤ºä¾‹è€Œå»å­¦ä¹ äº† JSDocï¼Œæ„Ÿå…´è¶£å¯æŸ¥çœ‹æˆ‘å¦å¤–ä¸€ç¯‡å­¦ä¹ ç¬”è®°ï¼šJSDocçš„å®‰è£…ä¸ä½¿ç”¨.md\nä»¥ä¸Šä»…ä»…æ˜¯ â€œè™šæ„â€ çš„æ ¸å¿ƒä»£ç ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¼–å†™å¯¹åº”çš„ â€œåº”ç”¨â€ å±‚é¢çš„ä»£ç ï¼š\nindex.tsxï¼šJS ä¸»åœºæ™¯ main ä»£ç \nworker.tsï¼šWorker åœºæ™¯ä»£ç \ncreate-world.tsï¼šè´Ÿè´£åˆ›å»º Three.js 3D åœºæ™¯çš„æ ¸å¿ƒä»£ç \ncreate-world.ts ä¸­çš„ä»£ç å¹¶ä¸çŸ¥é“è‡ªå·±å°†æ¥æ˜¯è¿è¡Œåœ¨ Worker ä¸­è¿˜æ˜¯è¿è¡Œåœ¨ ä¸»åœºæ™¯ä¸­(Main)\nå¦‚æœä½ èƒ½åšæŒçœ‹åˆ°è¿™é‡Œæ²¡æœ‰è¢«æˆ‘ç»•æ™•ï¼Œé‚£æ­å–œä½ ã€‚\næ˜¯ä¸æ˜¯è¯¥å±•ç¤ºå…·ä½“ä»£ç äº†ï¼Ÿ\né¡¹ç›®å®é™…ä»£ç  åŸç†éƒ½è®²è¿°å®Œäº†ï¼Œä½†æ˜¯æ¯ä¸ªç±»çš„ä»£ç ç»†èŠ‚å®åœ¨æ˜¯å¤ªå¤šï¼Œæˆ‘ä¹Ÿä¸æƒ³å†ç»†è‡´è®²è¿°äº†ï¼Œæ‰€ä»¥åœ¨ Github å•ç‹¬åˆ›å»ºäº†ä¸€ä¸ªé¡¹ç›®ï¼š\nhttps://github.com/puxiao/using-orbitcontrols-in-worker\nä¸ºäº†è®©å…¨ä¸–ç•Œçš„äººèƒ½çœ‹åˆ°æˆ‘çš„è¿™ä¸ªä»£ç ï¼Œæˆ‘ç«Ÿç„¶å†™äº†ä¸€ä¸ªè‹±æ–‡ç‰ˆ README.MD\nä½ å¯ä»¥ç›´æ¥æŸ¥çœ‹æˆ‘å†™çš„ç®€ä½“ä¸­æ–‡ä»‹ç»æ–‡æ¡£ï¼š\nhttps://github.com/puxiao/using-orbitcontrols-in-worker/blob/main/README-zh_CN.md\nè¯´ä¸€ä¸‹æˆ‘çš„æ„Ÿå— æœ¬èŠ‚åé¢çš„ä»£ç å®ç°ï¼ŒèŠ±è´¹äº†æˆ‘æœ‰ 1 ä¸ªæœˆçš„æ—¶é—´ï¼Œæ•´ä¸ªè¿‡ç¨‹å³å……å®æœ‰ç—›è‹¦ã€‚\nä»é˜…è¯»åŸç‰ˆæ•™ç¨‹ï¼Œå®Œå…¨çœ‹ä¸æ‡‚ ç†è§£ä¸äº† åæ¥å¯ä»¥ç†è§£ æ”¹ä¸ºè‡ªå·±çš„å®ç°æ–¹å¼ ä¸æ–­å¾—ä¿®æ”¹ã€ä¼˜åŒ–ä»£ç  ä¸Šä¼ åˆ° Github ç¼–å†™æ–‡æ¡£ å°½ç®¡æŒæ¡äº†æœ¬ç« æ‰€å†™çš„ç¤ºä¾‹ä»£ç ï¼Œä½†æ˜¯è¿™äº›å¯¹å®é™… Three.js çš„ä½¿ç”¨æå‡å¹¶ä¸ä¼šæœ‰ç«‹ç«¿è§å½±çš„æ•ˆæœã€‚\nä½†æ˜¯ å› ä¸ºä¸æ–­çš„æ·±å…¥å»ç†è§£ï¼Œå­¦ä¹ ï¼Œæˆ‘ä¹Ÿæœ‰å¾ˆå¤šæ”¶è·ï¼š\næˆ‘æˆåŠŸå‘ Three.js è´¡çŒ®äº†è‡ªå·±çš„ä¸€ç‚¹ç‚¹ä»£ç ï¼Œå°¤å…¶æ˜¯åœ¨æäº¤è‡ªå·±çš„ PR è¿‡ç¨‹ä¸­ï¼Œç”¨è¹©è„šè‹±è¯­ä¸ Three.js ä»£ç å®¡æŸ¥äººå‘˜çš„ä¸æ–­æ²Ÿé€šï¼Œæ˜¯ä¸€æ¬¡å¾ˆç¥å¥‡çš„ä½“éªŒã€‚\né€šè¿‡ OrbitControlsï¼Œé¡ºå¸¦æˆ‘ä¹Ÿçœ‹äº†å…¶ä»– è½¨é“æ§åˆ¶å™¨çš„ ä¸€äº›æºç ï¼Œäº‹å®ä¸Šæˆ‘åŸæœ¬çš„é‡å¿ƒè®¡åˆ’æ˜¯ç¼–å†™å‡ºæ‰€æœ‰è½¨é“æ§åˆ¶å™¨çš„ ControlsProxy ç‰ˆï¼Œä½†æ˜¯æ—¶é—´å’Œç²¾åŠ›ï¼Œè¿™ä¸ªäº‹æƒ…åªèƒ½æš‚æ—¶æ”¾ä¸‹ï¼Œç­‰å¾…å°†æ¥æˆ–è€…å…¶ä»–æ„Ÿå…´è¶£çš„äººæ¥ç¼–å†™å§ã€‚\nç›®å‰æˆ‘çš„é¡¹ç›®ä¸­åªç¼–å†™äº† OrbitControlsProxy.jsï¼Œå¦‚æœä½ æ„Ÿå…´è¶£ï¼Œä¹Ÿå¯ä»¥å°è¯•ç¼–å†™å‡ºå…¶ä»– è½¨é“æ§åˆ¶å™¨å¯¹åº”çš„ XxxControlsProxyã€‚\næé†’ï¼šå¦‚æœä½ æƒ³ç¼–å†™å…¶ä»–è½¨é“æ§åˆ¶å™¨çš„ä»£ç†ç®¡ç†ç±»ï¼Œå®ƒéœ€è¦ç»§æ‰¿äº ControlsProxyï¼Œç„¶åé‡å†™ configEventListener() å’Œ dispose() è¿™ 2 ä¸ªæ–¹æ³•ã€‚\nå­¦ä¹ äº† JSDoc æ³¨é‡Šè§„èŒƒï¼Œä¹Ÿå°±æ˜¯å³ä½¿æˆ‘ä»¬ä¸ä½¿ç”¨ TypeScriptï¼Œé€šè¿‡ JSDoc æ³¨é‡Šä¾ç„¶å¯ä»¥è¿›è¡Œç±»å‹å®šä¹‰ã€‚\né€šè¿‡ JSDoc çš„å­¦ä¹ ï¼Œè®©æˆ‘å¯¹ TypeScript æœ‰æ›´åŠ æ·±ä¸€å±‚çš„ç†è§£ã€‚\næ— è®º TypeScript è¿˜æ˜¯ JSDocï¼Œè¿˜æ˜¯ VSCode IDE æœ¬èº«çš„ä»£ç æç¤ºå’Œè‡ªåŠ¨æ£€æŸ¥ï¼Œæœ¬è´¨ä¸Šéƒ½ä»…ä»…åœ¨ å¼€å‘é˜¶æ®µ å¯¹æˆ‘ä»¬ç¼–å†™çš„ä»£ç è¿›è¡Œçº¦æŸï¼Œå°†æ¥ JS è¿è¡Œé˜¶æ®µå°±ç®¡ä¸äº†é‚£ä¹ˆå¤šäº†ã€‚\næ¥è§¦äº† //@ts-ignore è¿™ä¸ªç‰¹æ®Šæ³¨é‡Š\næœ¬å°èŠ‚ç»“æŸ æœ¬å°èŠ‚è‡³æ­¤ç»“æŸï¼ŒåŒæ—¶ä¹Ÿæ„å‘³ç€æœ¬ç³»åˆ—æ•™ç¨‹çš„ â€œä¼˜åŒ–â€ ç¯‡ç« è®²è§£å®Œæˆã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦å¼€å§‹æ–°çš„é˜¶æ®µå­¦ä¹ ï¼Œä¸‹ä¸€é˜¶æ®µæ‰å†³å®šæˆ‘ä»¬ Three.js å®é™…åº”ç”¨é¢†åŸŸ â€œè´¨çš„é£è¶Šâ€ã€‚\nä¸‹ä¸€é˜¶æ®µï¼Œæˆ‘ä»¬è¦å¼€å§‹å­¦ä¹  Three.js ä¸­å¸¸è§çš„å„ç§åº”ç”¨åœºæ™¯è§£å†³æ–¹æ¡ˆã€‚\nåŠ æ²¹ï¼Œå¥½ç©æœ‰è¶£çš„äº‹æƒ…ç»ˆäºè¦å¼€å§‹äº†ã€‚\n","wordCount":"9060","inLanguage":"en","datePublished":"2023-12-19T17:11:35+08:00","dateModified":"2023-12-19T17:11:35+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://bablvsj.github.io/posts/threejs/22-three.js%E4%BC%98%E5%8C%96%E4%B9%8Boffscreencanvas%E4%B8%8Ewebworker/"},"publisher":{"@type":"Organization","name":"Bablvsj's Blog","logo":{"@type":"ImageObject","url":"https://bablvsj.github.io/img/Q.gif"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bablvsj.github.io accesskey=h title="Bablvsj's Blog (Alt + H)">Bablvsj's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bablvsj.github.io/ title=ä¸»é¡µ><span>ä¸»é¡µ</span></a></li><li><a href=https://bablvsj.github.io/archives/ title=æ—¶é—´è½´><span>æ—¶é—´è½´</span></a></li><li><a href=https://bablvsj.github.io/tags title=æ ‡ç­¾><span>æ ‡ç­¾</span></a></li><li><a href=https://bablvsj.github.io/about title=å…³äº><span>å…³äº</span></a></li><li><a href=https://bablvsj.github.io/search title="ğŸ” (Alt + /)" accesskey=/><span>ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>22 Three.jsä¼˜åŒ–ä¹‹OffscreenCanvasä¸WebWorker</h1><div class=post-meta><div class=post-tags-meta><a href=https://bablvsj.github.io/tags/three.js/>Three.js</a></div>19 min&nbsp;Â·&nbsp;<span title='2023-12-19 17:11:35 +0800 +0800'>2023/12/19</span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><div class=inner><ul><li><a href=#offscreencanvas%e7%9a%84%e6%a6%82%e5%bf%b5%e5%92%8c%e7%94%a8%e6%b3%95 aria-label=OffscreenCanvasçš„æ¦‚å¿µå’Œç”¨æ³•>OffscreenCanvasçš„æ¦‚å¿µå’Œç”¨æ³•</a><ul><ul><li><a href=#offscreencanvas%e7%9a%84%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5 aria-label=OffscreenCanvasçš„åŸºæœ¬æ¦‚å¿µ>OffscreenCanvasçš„åŸºæœ¬æ¦‚å¿µ</a></li><li><a href=#offscreencanvas%e7%9a%84%e7%94%a8%e6%b3%95 aria-label=OffscreenCanvasçš„ç”¨æ³•>OffscreenCanvasçš„ç”¨æ³•</a></li></ul></ul></li><li><a href=#%e7%a6%bb%e5%b1%8f%e7%94%bb%e5%b8%83%e6%b8%b2%e6%9f%93%e7%a4%ba%e4%be%8bhellooffscreencanvas aria-label=ç¦»å±ç”»å¸ƒæ¸²æŸ“ç¤ºä¾‹ï¼šHelloOffscreenCanvas>ç¦»å±ç”»å¸ƒæ¸²æŸ“ç¤ºä¾‹ï¼šHelloOffscreenCanvas</a><ul><ul><li><a href=#%e7%a4%ba%e4%be%8b%e7%9b%ae%e6%a0%87 aria-label=ç¤ºä¾‹ç›®æ ‡>ç¤ºä¾‹ç›®æ ‡</a></li><li><a href=#%e5%85%b3%e9%94%ae%e7%82%b9%e8%af%b4%e6%98%8e aria-label=å…³é”®ç‚¹è¯´æ˜>å…³é”®ç‚¹è¯´æ˜</a></li><li><a href=#%e5%85%b6%e4%bb%96%e8%a1%a5%e5%85%85 aria-label=å…¶ä»–è¡¥å……>å…¶ä»–è¡¥å……</a></li><li><a href=#message-datats aria-label=message-data.ts>message-data.ts</a></li><li><a href=#workerts aria-label=worker.ts>worker.ts</a></li><li><a href=#indextsx aria-label=index.tsx>index.tsx</a></li></ul></ul></li><li><a href=#%e6%a8%a1%e6%8b%9f%e5%b9%b6%e6%b7%bb%e5%8a%a0orbitcontrols aria-label=æ¨¡æ‹Ÿå¹¶æ·»åŠ OrbitControls>æ¨¡æ‹Ÿå¹¶æ·»åŠ OrbitControls</a><ul><ul><li><a href=#%e7%9b%ae%e5%89%8d%e6%97%a0%e6%b3%95%e4%bd%bf%e7%94%a8orbitcontrols%e7%9a%84%e5%9b%b0%e5%a2%83 aria-label=ç›®å‰æ— æ³•ä½¿ç”¨OrbitControlsçš„å›°å¢ƒ>ç›®å‰æ— æ³•ä½¿ç”¨OrbitControlsçš„å›°å¢ƒ</a></li><li><a href=#%e9%82%a3%e4%b9%88%e7%a9%b6%e7%ab%9f%e8%af%a5%e6%80%8e%e4%b9%88%e5%8a%9e%e5%91%a2 aria-label=é‚£ä¹ˆç©¶ç«Ÿè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ>é‚£ä¹ˆç©¶ç«Ÿè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</a></li></ul><li><a href=#%e6%95%b4%e4%bd%93%e6%80%9d%e8%b7%af%e7%a4%ba%e6%84%8f%e5%9b%be aria-label=æ•´ä½“æ€è·¯ç¤ºæ„å›¾>æ•´ä½“æ€è·¯ç¤ºæ„å›¾</a><ul><li><a href=#%e4%bb%a3%e7%a0%81%e6%a8%a1%e5%9d%97%e8%a7%84%e5%88%92 aria-label=ä»£ç æ¨¡å—è§„åˆ’>ä»£ç æ¨¡å—è§„åˆ’</a></li></ul></li><li><a href=#%e9%a1%b9%e7%9b%ae%e5%ae%9e%e9%99%85%e4%bb%a3%e7%a0%81 aria-label=é¡¹ç›®å®é™…ä»£ç >é¡¹ç›®å®é™…ä»£ç </a></li><li><a href=#%e8%af%b4%e4%b8%80%e4%b8%8b%e6%88%91%e7%9a%84%e6%84%9f%e5%8f%97 aria-label=è¯´ä¸€ä¸‹æˆ‘çš„æ„Ÿå—>è¯´ä¸€ä¸‹æˆ‘çš„æ„Ÿå—</a><ul><li><a href=#%e4%bd%86%e6%98%af aria-label=ä½†æ˜¯>ä½†æ˜¯</a></li></ul></li><li><a href=#%e6%9c%ac%e5%b0%8f%e8%8a%82%e7%bb%93%e6%9d%9f aria-label=æœ¬å°èŠ‚ç»“æŸ>æœ¬å°èŠ‚ç»“æŸ</a></li></ul></li></ul></div></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>æˆ‘ä»¬çŸ¥é“ JS æ˜¯å•çº¿ç¨‹ï¼Œå¯ä»¥é€šè¿‡ WebWorker å°†ä¸€äº›å¤æ‚è®¡ç®—æ‰§è¡Œå‘½ä»¤ä»ä¸»çº¿ç¨‹ä¸­åˆ†ç¦»å‡ºæ¥ã€‚</p><p>å…³äº WebWorker çš„ä½¿ç”¨æ–¹æ³•ï¼Œè¯·å‚è€ƒï¼š</p><p><a href=https://developer.mozilla.org/zh-cn/docs/web/api/web_workers_api/using_web_workers>https://developer.mozilla.org/zh-cn/docs/web/api/web_workers_api/using_web_workers</a></p><p>æˆ–è€…æŸ¥çœ‹æˆ‘å†™çš„å¦å¤–ä¸€ç¯‡æ–‡ç« ï¼š<a href=https://github.com/puxiao/notes/blob/master/WebWorker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.md>WebWorkerå­¦ä¹ ç¬”è®°.md</a></p><br><p>ä¸€äº›æ¯”è¾ƒæ–°çš„æµè§ˆå™¨(ä¾‹å¦‚è°·æ­Œæµè§ˆå™¨) è¿˜æœ‰å¦å¤–ä¸€ä¸ªå’Œ WebWorker æ­é…ä½¿ç”¨ã€é’ˆå¯¹ç”»å¸ƒçš„ç±»ï¼šOffscreenCanvasã€‚</p><p><strong>OffscreenCanvas çš„ä½œç”¨å°±æ˜¯å°† canvas çš„æ§åˆ¶æƒè½¬è®©ç»™ Web Workerã€‚</strong></p><blockquote><p>å› æ­¤ OffscreenCanvas å¿…é¡»æ­é… Web Worker ä¸€èµ·ä½¿ç”¨ã€‚</p></blockquote><blockquote><p>è¡¥å……ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼š</p><p>å’Œ OffscreenCanvas ç±»ä¼¼çš„è¿˜æœ‰ ArrayBufferã€ MessagePortã€ImageBitmapï¼Œä»–ä»¬éƒ½å¯ä»¥ä¸ WebWorker æ­é…ä½¿ç”¨</p></blockquote><br><h2 id=offscreencanvasçš„æ¦‚å¿µå’Œç”¨æ³•>OffscreenCanvasçš„æ¦‚å¿µå’Œç”¨æ³•<a hidden class=anchor aria-hidden=true href=#offscreencanvasçš„æ¦‚å¿µå’Œç”¨æ³•>#</a></h2><h4 id=offscreencanvasçš„åŸºæœ¬æ¦‚å¿µ>OffscreenCanvasçš„åŸºæœ¬æ¦‚å¿µ<a hidden class=anchor aria-hidden=true href=#offscreencanvasçš„åŸºæœ¬æ¦‚å¿µ>#</a></h4><p>ä½ å¯ä»¥æŠŠ WebWorker åšä¸ºå„ç§å¤æ‚ç±»å‹çš„åå°è¿ç®—çº¿ç¨‹ï¼Œä½œç”¨èŒƒå›´æ¯”è¾ƒå¹¿æ³›ã€‚</p><p>è€Œ OffscreenCanvas åˆ™ä¸“é—¨é’ˆå¯¹ Canvas åšç¦»å±æ¸²æŸ“ã€‚</p><blockquote><p>æ³¨æ„ï¼Œè¿™é‡Œæåˆ°çš„ ç¦»å±æ¸²æŸ“ å’Œ æˆ‘ä»¬ä½¿ç”¨ WebGLRendererTarget æ¥åšçš„ç¦»å±æ¸²æŸ“ï¼Œä»æ¦‚å¿µä¸Šæ˜¯ç±»ä¼¼çš„</p></blockquote><blockquote><p>OffscreenCanvas çš„ â€œç¦»å±â€ æ˜¯æŒ‡æµè§ˆå™¨ DOM è€Œè¨€</p><p>WebGLRenderTarget çš„ â€œç¦»å±â€ åªæŒ‡ Three.js çš„ä¸»åœºæ™¯(Scene) è€Œè¨€</p></blockquote><p>ä½ å¯ä»¥æŠŠ OffscreenCanvas çœ‹ä½œæ˜¯é’ˆå¯¹ Canvas çš„ç‰¹æ®Š WebWorker åº”ç”¨åœºæ™¯ã€‚</p><p>ä½†æ˜¯è¯·è®°å¾—ï¼šç›®å‰ç»å¤§å¤šæ•°æµè§ˆå™¨å‡å·²æ”¯æŒ WebWorkerï¼Œä½†æ˜¯å¯¹ OffscreenCanvas çš„æ”¯æŒåº¦å¹¶ä¸é«˜ã€‚</p><br><p><strong>å¦‚ä½•åˆ›å»º OffscreenCanvas ï¼Ÿ</strong></p><p>ä¸å¯ä»¥ä½¿ç”¨ new OffscreenWorker() çš„æ–¹å¼æ¥åˆ›å»º OffscreenCanvasï¼Œè€Œæ˜¯ä½¿ç”¨ canvas.transferControlToOffscreen() æ¥è·å¾— canvas å¯¹åº”çš„ OffscreenCanvasã€‚</p><br><p><strong>å¦‚ä½•æ£€æµ‹å½“å‰æµè§ˆå™¨æ˜¯å¦æ”¯æŒ OffscreenCanvasï¼Ÿ</strong></p><p>æˆ‘ä»¬åªéœ€æ£€æŸ¥ canvas æ˜¯å¦å­˜åœ¨ transferControlToOffscreen æ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>if(canvas.transferControlToOffscreen !== null){
</span></span><span style=display:flex><span>    console.log(&#39;å½“å‰æµè§ˆå™¨æ”¯æŒ OffscreenCanvas&#39;)
</span></span><span style=display:flex><span>}else{
</span></span><span style=display:flex><span>    console.log(&#39;å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ OffscreenCanvas&#39;)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>æˆ‘ä»¬æ˜¯é€šè¿‡æ£€æŸ¥ canvas å¯¹è±¡ä¸Šæ˜¯å¦åŒ…å« .transferControlToOffscreen æ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦å½“å‰æµè§ˆå™¨æ”¯æŒ OffscreenCanvas çš„ã€‚</p><p>è¿™é‡Œè¡¥å……ä¸€ä¸ª JS çŸ¥è¯†ï¼Œå¦‚ä½•åˆ¤æ–­æŸä¸ªå¯¹è±¡ä¸Šæ˜¯å¦æœ‰æŸä¸ªå±æ€§ã€‚</p><p>å‡è®¾æœ‰ä¸€ä¸ªå¯¹è±¡</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>const obj = {
</span></span><span style=display:flex><span>  a:undefined,
</span></span><span style=display:flex><span>  b:null
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>æ­¤æ—¶æˆ‘ä»¬ä½¿ç”¨ if(obj.a) æˆ– if(obj.b) éƒ½æ˜¯æ— æ³•å‡†ç¡®åˆ¤æ–­å‡ºåˆ°åº• å±æ€§ aã€b æ˜¯å¦å­˜åœ¨ã€‚</p><p>é‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ 2 ç§æ–¹å¼æ¥è¿›è¡Œåˆ¤æ–­ï¼š</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>if(&#39;a&#39; in obj) { ... }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>if(Reflect.has(obj,&#39;b&#39;)){ ... }
</span></span></code></pre></div><p>ä½¿ç”¨ in æˆ–è€… Reflect.has() å°±å¯ä»¥å‡†ç¡®åˆ¤æ–­å‡ºå¯¹è±¡ä¸Šæ˜¯å¦å…·æœ‰æŸå±æ€§æˆ–æ–¹æ³•ï¼Œå³ä½¿è¯¥å±æ€§çš„å€¼ä¸º undefined</p><blockquote><p>æ³¨æ„ï¼šä¸Šé¢ 2 ç§æŸ¥è¯¢æ–¹å¼éƒ½éœ€è¦å±æ€§åçš„å­—ç¬¦ä¸²å€¼ï¼Œä¸ºäº†æ›´å¥½çš„è¯­æ³•æç¤ºï¼Œæˆ‘ä»¬ç¤ºä¾‹ä¸­å¹¶ä¸è¿™æ ·ç”¨ã€‚</p></blockquote></blockquote><br><h4 id=offscreencanvasçš„ç”¨æ³•>OffscreenCanvasçš„ç”¨æ³•<a hidden class=anchor aria-hidden=true href=#offscreencanvasçš„ç”¨æ³•>#</a></h4><blockquote><p>å†æ¬¡å¼ºè°ƒï¼šé€šå¸¸æƒ…å†µä¸‹ OffscreenCanvas å¿…é¡»æ­é… Web Worker ä¸€èµ·ä½¿ç”¨ã€‚</p></blockquote><p>æˆ‘ä»¬å•ç‹¬åˆ›å»ºä¸€ä¸ª JS æ–‡ä»¶ï¼Œå°† canvas ç»˜åˆ¶çš„ä¸€äº› JS ä»£ç å†™åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ã€‚</p><p><strong>å¤§ä½“æ­¥éª¤ï¼š</strong></p><ol><li><p>åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ JS æ–‡ä»¶ï¼Œç”¨æ¥ç¼–å†™ Three.js åœºæ™¯å†…å®¹å’Œæ¸²æŸ“ä»£ç </p><blockquote><p>ä¼šä»¥è¿™ä¸ª JS æ–‡ä»¶æ¥ä½œä¸º web worker çš„è°ƒç”¨æ–‡ä»¶å¯¹è±¡</p></blockquote></li><li><p>åœ¨ä¸»åœºæ™¯ä¸­ï¼Œè·å¾— DOM ä¸­çš„ canvas</p></li><li><p>è·å– canvas å¯¹åº”çš„ OffscreenCanvas</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>const offscreen = canvas.transferCountrolToOffscreen()
</span></span></code></pre></div></li><li><p>åˆ›å»ºä¸€ä¸ª worker å¯¹è±¡ï¼Œå¹¶ä¸”è®¾ç½®ä¸€äº›æ¶ˆæ¯å‚æ•°</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>const worker = new Window.Worker(&#39;xx/xxxx.js&#39;,{type:&#39;module&#39;})
</span></span><span style=display:flex><span>worker.postMessage({type:&#39;main&#39;,canvas:offscreen},[offscreen])
</span></span></code></pre></div></li><li><p>ç”±äº web worker ä¸å…è®¸è®¿é—® DOM äº‹ä»¶ï¼Œä¾‹å¦‚æµè§ˆå™¨çª—å£å°ºå¯¸æ”¹å˜äº‹ä»¶ã€é¼ æ ‡äº‹ä»¶ç­‰ï¼Œæ‰€ä»¥å½“è¿™äº›äº‹ä»¶å‘ç”Ÿåï¼Œæˆ‘ä»¬éœ€è¦é€šçŸ¥ workerï¼Œå°†äº‹ä»¶å¯¹åº”çš„ä¸€äº›å‚æ•°å’Œå˜åŠ¨å‘é€ç»™ workerï¼Œä»¥ä¾¿ worker ä¸­çš„ canvas æ¸²æŸ“é€»è¾‘ä½œå‡ºå¯¹åº”çš„å“åº”ã€‚</p><blockquote><p>çª—å£å°ºå¯¸æ”¹å˜äº‹ä»¶æˆ‘ä»¬è¿˜æ¯”è¾ƒå®¹æ˜“è§£å†³ï¼Œæ— éå°±æ˜¯æŠŠæ–°çš„å°ºå¯¸å‘é€ç»™ workerï¼Œæ¯”è¾ƒéš¾çš„æ˜¯åƒ é¼ æ ‡äº‹ä»¶ã€é”®ç›˜äº‹ä»¶ç­‰ï¼Œéœ€è¦ç¨å¾®å¤æ‚çš„ä¸€äº›ä¼ é€’æ–¹å¼æ‰å¯ä»¥è§£å†³ã€‚</p><p>åœ¨æœ¬æ–‡ååŠéƒ¨åˆ†ä¼šæœ‰è¯¦ç»†è®²è§£ã€‚</p></blockquote></li></ol><br><p><strong>å®é™…å·®å¼‚ï¼š</strong></p><p>åˆšæ‰å°†çš„æ˜¯ç†è®ºä¸Šå¤§ä½“æ­¥éª¤ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬æœ¬æ•™ç¨‹çš„ç¤ºä¾‹ä»£ç ï¼Œå®é™…ä¸Šæ˜¯è¿è¡Œåœ¨ React + TypeScript ç¯å¢ƒä¸Šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬éœ€è¦ç¼–å†™çš„æ˜¯ worker.ts è€Œä¸æ˜¯ worker.jsã€‚</p><blockquote><p>å½“ç„¶ä½ ä¹Ÿå¯ä»¥é‡‡å–åœ¨ç¼–å†™ worker æ—¶ä½¿ç”¨ .js è€Œä¸æ˜¯ .tsï¼Œåªä¸è¿‡è¿™æ ·å°±å¤±å»äº† TypeScript çš„ä¾¿åˆ©æ€§ã€‚</p></blockquote><p>æˆ‘ä»¬æ¨èçš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ webpack çš„æ’ä»¶ï¼šworker-loader æ¥è§£å†³ react + typescript ç¯å¢ƒä¸­ç¼–å†™ workerã€‚</p><p>å…·ä½“çš„é…ç½®æ­¥éª¤ï¼Œè¯·å‚è€ƒæˆ‘å†™çš„å¦å¤–ä¸€ç¯‡æ–‡ç« ï¼š<a href=https://github.com/puxiao/notes/blob/master/WebWorker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.md#React%E5%86%85%E5%B5%8CWebWorker%E4%BB%A3%E7%A0%81>Reactå†…åµŒWebWorkerä»£ç </a></p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼Œæ¥æ¼”ç¤ºä¸€é OffscreenCanvas + Workerã€‚</p><br><h2 id=ç¦»å±ç”»å¸ƒæ¸²æŸ“ç¤ºä¾‹hellooffscreencanvas>ç¦»å±ç”»å¸ƒæ¸²æŸ“ç¤ºä¾‹ï¼šHelloOffscreenCanvas<a hidden class=anchor aria-hidden=true href=#ç¦»å±ç”»å¸ƒæ¸²æŸ“ç¤ºä¾‹hellooffscreencanvas>#</a></h2><p>å‡è®¾ä½ å·²ç»é…ç½®å¥½äº† worker-loaderï¼Œé‚£ä¹ˆæˆ‘ä»¬å¼€å§‹æœ¬ç¤ºä¾‹ã€‚</p><br><h4 id=ç¤ºä¾‹ç›®æ ‡>ç¤ºä¾‹ç›®æ ‡<a hidden class=anchor aria-hidden=true href=#ç¤ºä¾‹ç›®æ ‡>#</a></h4><ol><li>åœºæ™¯ä¸Šæœ‰ 3 ä¸ªä¸åŒé¢œè‰²ï¼Œä¸æ–­æ—‹è½¬çš„ç«‹æ–¹ä½“</li><li>æˆ‘ä»¬å°†åœºæ™¯ä¸­çš„æ¸²æŸ“å·¥ä½œï¼Œä»ä¸»ç¨‹åºä¸­æŠ½ç¦»å‡ºå»ï¼Œè®© Web Worker æ¥è´Ÿè´£åœºæ™¯çš„æ¸²æŸ“å·¥ä½œï¼Œä¾æ¬¡æ¥å‡è½»ä¸»ç¨‹åºçš„è¿ç®—è´Ÿæ‹…ã€‚</li></ol><br><p><strong>è¡¥å……è¯´æ˜ï¼š</strong></p><ol><li>æˆ‘ä»¬åœºæ™¯ä¸­åŠ¨ç”»æ¸²æŸ“æœ¬èº«è®¡ç®—é‡å¹¶ä¸æ˜¯å¾ˆå¤§ï¼Œå³ä½¿æˆ‘ä»¬ä¸ä½¿ç”¨ web worker æµè§ˆå™¨ä¹Ÿä¸ä¼šå¡é¡¿ï¼Œä½†æœ¬ç¤ºä¾‹åªæ˜¯ä¸ºäº†æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ OffscreenCanvas + Workerã€‚</li><li>æˆ‘ä»¬å…ˆå‡è®¾ä½ çš„æµè§ˆå™¨æ˜¯æ”¯æŒ OffscreenCanvas çš„ã€‚</li></ol><br><h4 id=å…³é”®ç‚¹è¯´æ˜>å…³é”®ç‚¹è¯´æ˜<a hidden class=anchor aria-hidden=true href=#å…³é”®ç‚¹è¯´æ˜>#</a></h4><p>é»˜è®¤ ä¸»ç¨‹åº(index.tsx æˆ– index.ts) ä¸ åˆ†çº¿ç¨‹(Worker.ts) å½¼æ­¤é€šè¿‡ .postMessage() äº’ç›¸å‘é€æ•°æ®ã€‚</p><p>è€Œ .postMessage() é»˜è®¤å‘é€çš„æ•°æ®æ˜¯æ·±æ‹·è´ï¼Œè€Œä¸æ˜¯å¼•ç”¨ã€‚</p><blockquote><p>å› ä¸ºæœ¬è´¨ä¸Š index.tsx å’Œ worker.ts å°±ä¸åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œæ— æ³•å…±äº«æ•°æ®</p><p>æ”¯æŒå…±äº«æ•°æ®çš„ SharedWorker ç›®å‰æµè§ˆå™¨æ”¯æŒåº¦è¿˜ä¸å¤Ÿé«˜ã€‚</p></blockquote><p>å‡è®¾æˆ‘ä»¬æ˜¯æŠŠåœºæ™¯æ¸²æŸ“çš„è®¡ç®—å·¥ä½œè½¬ç§»åˆ°äº† worker.ts ä¸­ï¼Œä½†æ˜¯ worker.ts æ¯æ¬¡è®¡ç®—å¥½ canvas ç”»é¢å†…å®¹åå†å‘é€ç»™ index.tsxï¼Œæ¯æ¬¡éƒ½æ‰§è¡Œä¸€æ¬¡æ·±æ‹·è´ï¼Œæ€§èƒ½åè€Œä½ä¸‹ã€‚</p><blockquote><p>Web Worker æœ¬èº«æ˜¯æ— æ³•è®¿é—® DOM å…ƒç´ çš„</p></blockquote><p>å¹¸å¥½ .postMessage() æ–¹æ³•çš„ç¬¬ 2 ä¸ªå‚æ•°ï¼Œå…è®¸æˆ‘ä»¬å°†ä¸€äº›æ•°æ®ç±»å‹æ¯”è¾ƒå¤§çš„å¯¹è±¡ï¼Œç›´æ¥å°†æ§åˆ¶æƒè½¬ç§»ç»™ worker.tsã€‚</p><p><strong>ä¹Ÿå°±æ˜¯è¯´ï¼ŒOffscreenCanvas + Worker ä¸æ˜¯èµ°ä»¥ä¸‹æµç¨‹ï¼š</strong></p><ol><li>worker.ts è´Ÿè´£åˆ›å»º Three.js åœºæ™¯å’Œç‰©ä½“</li><li>worket.ts è´Ÿè´£æ¸²æŸ“å¾—åˆ° åœºæ™¯ç”»é¢æ•°æ®</li><li>worket.ts é€šè¿‡ .postMessage() å°†ç¦»å±æ¸²æŸ“å¾—åˆ°çš„ ç”»å¸ƒç”»é¢å†…å®¹æ•°æ® å‘é€ç»™ index.tsx</li><li>index.tsx æ¥æ”¶ ç”»å¸ƒç”»é¢å†…å®¹æ•°æ® å¹¶æ¸²æŸ“åˆ° canvas DOM ä¸­</li></ol><p><strong>è€Œæ˜¯èµ°ä»¥ä¸‹æµç¨‹ï¼š</strong></p><ol><li>index.tsx é€šè¿‡ canvas.transferToOffscreenCanvas() å¾—åˆ° OffscreenCanvas</li><li>index.tsx é€šè¿‡ .postMessage() ç¬¬ 2 ä¸ªå‚æ•°ï¼Œå°† [OffscreenCanavs] ä¼ é€’ç»™ worker.tsï¼Œä¹Ÿå°±æ˜¯è¯´å°† canvas çš„æ§åˆ¶æƒå®Œå…¨äº¤ç»™ worker.ts</li><li>æ¥ä¸‹æ¥å°±æ˜¯ worker.ts è´Ÿè´£åˆ›å»º Three.js åœºæ™¯å’Œç‰©ä½“ï¼Œå¹¶ä¸”æ¸²æŸ“åœºæ™¯ç”»é¢å†…å®¹ç›´æ¥èµ‹äºˆç»™ OffscreenCanavasã€‚</li></ol><br><h4 id=å…¶ä»–è¡¥å……>å…¶ä»–è¡¥å……<a hidden class=anchor aria-hidden=true href=#å…¶ä»–è¡¥å……>#</a></h4><p>ç”±äº worker æœ¬èº«æ— æ³•è·å– DOM ï¼Œä»¥åŠæ— æ³•è·å–æµè§ˆå™¨æŸäº›äº‹ä»¶ï¼Œä¾‹å¦‚æµè§ˆå™¨çš„çª—å£å¤§å°å˜åŠ¨äº‹ä»¶ã€‚</p><p>æ‰€ä»¥å½“æµè§ˆå™¨çª—å£å°ºå¯¸å‘ç”Ÿå˜åŒ–åï¼Œæˆ‘ä»¬è¦è®© index.tsx åŠæ—¶é€šçŸ¥ worker.ts æ–°çš„æµè§ˆå™¨çª—å£å®½é«˜ï¼Œä»¥ä¾¿è®© worker.ts ä½œå‡ºç›¸åº”çš„è°ƒæ•´ã€‚</p><blockquote><p>ä¸çª—å£å°ºå¯¸æ”¹å˜ç›¸ä¼¼çš„è¿˜æœ‰é¼ æ ‡ç§»åŠ¨äº‹ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¼ é€’å½“å‰é¼ æ ‡åæ ‡ä½ç½®ä¼ é€’ç»™ Worker ä»¥ä¾¿åšå‡ºç›¸åº”çš„å¤„ç†ã€‚åæœŸæˆ‘ä»¬ä¼šå­¦ä¹ å¦‚ä½•åšåœºæ™¯ç‰©ä½“æ‹¾å–æ•ˆæœï¼Œå°±æ˜¯é¼ æ ‡æ”¾åˆ°æŸä¸ªç‰©ä½“ä¸Šæ—¶ç‰©ä½“åšå‡ºç›¸åº”å˜åŒ–ï¼Œè¿™ç§åœºæ™¯å°±ä¼šéœ€è¦ç”¨åˆ°é¼ æ ‡åæ ‡ã€‚</p></blockquote><p>æ¥ä¸‹æ¥ï¼Œå°±å¼€å§‹å…·ä½“ç¼–å†™ä»£ç å§ã€‚</p><br><h4 id=message-datats>message-data.ts<a hidden class=anchor aria-hidden=true href=#message-datats>#</a></h4><blockquote><p>src/components/hello-offscreen-canvas/message-data.ts</p></blockquote><p>message-data.ts çš„ä½œç”¨æ˜¯å®šä¹‰ä¸€äº›å‚æ•°åã€å‚æ•°å€¼çš„ç±»å‹ï¼Œä»¥ä¾¿æˆ‘ä»¬è·å¾—å¥½çš„ TS è¯­æ³•æç¤ºã€‚</p><blockquote><p>æ³¨æ„ï¼šmessage-data.ts ä¼šåŒæ—¶è¢« index.tsx å’Œ worker.ts å¼•å…¥ï¼Œè¿™æ ·åšçš„æ•ˆæœæ˜¯ï¼š</p><ol><li>index.tsx å¯ä»¥æ¯”è¾ƒå®¹æ˜“çŸ¥é“ worker.ts å†…éƒ¨å®šä¹‰çš„å‡½æ•°åå«ä»€ä¹ˆ</li><li>worker.ts å¯ä»¥æ¯”è¾ƒå®¹æ˜“çŸ¥é“ index.tsx ä¼ é€’è¿‡æ¥çš„å‚æ•°ç±»å‹æ˜¯ä»€ä¹ˆ</li></ol></blockquote><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>//å®šä¹‰ç”»å¸ƒçš„å°ºå¯¸ç±»å‹æ•°æ®ç»“æ„
</span></span><span style=display:flex><span>export type CanvasSize = {
</span></span><span style=display:flex><span>    width: number,
</span></span><span style=display:flex><span>    height: number
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export enum WorkerFunName {
</span></span><span style=display:flex><span>    main = &#39;main&#39;,
</span></span><span style=display:flex><span>    updateSize = &#39;updateSize&#39;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>//å®šä¹‰ MessageEvent data çš„æ•°æ®ç»“æ„
</span></span><span style=display:flex><span>export type MessageData =
</span></span><span style=display:flex><span>    { type: WorkerFunName.main, params: OffscreenCanvas }
</span></span><span style=display:flex><span>    |
</span></span><span style=display:flex><span>    { type: WorkerFunName.updateSize, params: CanvasSize }
</span></span></code></pre></div><br><h4 id=workerts>worker.ts<a hidden class=anchor aria-hidden=true href=#workerts>#</a></h4><blockquote><p>src/components/hello-offscreen-canvas/worker.ts</p></blockquote><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>import * as Three from &#39;three&#39;
</span></span><span style=display:flex><span>import { CanvasSize, MessageData, WorkerFunName } from &#39;./message-data&#39;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>let renderer: Three.WebGLRenderer
</span></span><span style=display:flex><span>let camera: Three.PerspectiveCamera
</span></span><span style=display:flex><span>let scene: Three.Scene
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>//å®šä¹‰åˆå§‹åŒ–çš„å‡½æ•°
</span></span><span style=display:flex><span>const main = (canvas: OffscreenCanvas) =&gt; {
</span></span><span style=display:flex><span>    //å¼€å§‹åˆ›å»º 3D ç›¸å…³åœºæ™¯
</span></span><span style=display:flex><span>    renderer = new Three.WebGLRenderer({ canvas })
</span></span><span style=display:flex><span>    camera = new Three.PerspectiveCamera(45, 2, 0.1, 100)
</span></span><span style=display:flex><span>    camera.position.z = 4
</span></span><span style=display:flex><span>    scene = new Three.Scene()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    const colors = [&#39;blue&#39;, &#39;red&#39;, &#39;green&#39;]
</span></span><span style=display:flex><span>    const cubes: Three.Mesh[] = []
</span></span><span style=display:flex><span>    colors.forEach((color, index) =&gt; {
</span></span><span style=display:flex><span>        const material = new Three.MeshPhongMaterial({ color })
</span></span><span style=display:flex><span>        const geometry = new Three.BoxBufferGeometry(1, 1, 1)
</span></span><span style=display:flex><span>        const mesh = new Three.Mesh(geometry, material)
</span></span><span style=display:flex><span>        mesh.position.x = (index - 1) * 2
</span></span><span style=display:flex><span>        scene.add(mesh)
</span></span><span style=display:flex><span>        cubes.push(mesh)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    const light = new Three.DirectionalLight(0xFFFFFF, 1)
</span></span><span style=display:flex><span>    light.position.set(-2, 2, 2)
</span></span><span style=display:flex><span>    scene.add(light)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    const render = (time: number) =&gt; {
</span></span><span style=display:flex><span>        time *= 0.001
</span></span><span style=display:flex><span>        cubes.forEach((item) =&gt; {
</span></span><span style=display:flex><span>            item.rotation.set(time, time, 0)
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        renderer.render(scene, camera)
</span></span><span style=display:flex><span>        self.requestAnimationFrame(render)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    self.requestAnimationFrame(render)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>//å®šä¹‰ç”¨æ¥æ¥æ”¶ç”»å¸ƒå°ºå¯¸æ›´æ–°çš„å‡½æ•°
</span></span><span style=display:flex><span>const updateSize = (newSize: CanvasSize) =&gt; {
</span></span><span style=display:flex><span>    camera.aspect = newSize.width / newSize.height
</span></span><span style=display:flex><span>    camera.updateProjectionMatrix()
</span></span><span style=display:flex><span>    renderer.setSize(newSize.width, newSize.height, false)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>const handleMessage = ((eve: MessageEvent&lt;MessageData&gt;) =&gt; {
</span></span><span style=display:flex><span>    switch (eve.data.type) {
</span></span><span style=display:flex><span>        case WorkerFunName.main:
</span></span><span style=display:flex><span>            main(eve.data.params)
</span></span><span style=display:flex><span>            break
</span></span><span style=display:flex><span>        case WorkerFunName.updateSize:
</span></span><span style=display:flex><span>            updateSize(eve.data.params)
</span></span><span style=display:flex><span>            break
</span></span><span style=display:flex><span>        default:
</span></span><span style=display:flex><span>            throw new Error(`no handle for the type`)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>self.addEventListener(&#39;message&#39;, handleMessage)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>const handleMessageError = () =&gt; {
</span></span><span style=display:flex><span>    throw new Error(&#39;Worker.ts: message error ...&#39;)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>self.addEventListener(&#39;messageerror&#39;, handleMessageError)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>//å¯¼å‡º {} æ˜¯å› ä¸º .ts ç±»å‹çš„æ–‡ä»¶å¿…é¡»æœ‰å¯¼å‡ºå¯¹è±¡æ‰å¯ä»¥è¢« TS ç¼–è¯‘æˆæ¨¡å—ï¼Œè€Œä¸æ˜¯å…¨å±€å¯¹è±¡
</span></span><span style=display:flex><span>export { }
</span></span></code></pre></div><br><h4 id=indextsx>index.tsx<a hidden class=anchor aria-hidden=true href=#indextsx>#</a></h4><blockquote><p>src/components/hello-offscreen-canvas/index.tsx</p></blockquote><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>import { useEffect, useRef } from &#39;react&#39;
</span></span><span style=display:flex><span>import { WorkerFunName } from &#39;./message-data&#39;
</span></span><span style=display:flex><span>import Worker from &#39;worker-loader!./worker&#39;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>import &#39;./index.scss&#39;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>const HelloOffscreenCanvas = () =&gt; {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    const canvasRef = useRef&lt;HTMLCanvasElement | null&gt;(null)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    useEffect(() =&gt; {
</span></span><span style=display:flex><span>        if (canvasRef.current === null) { return }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        const canvas = canvasRef.current as HTMLCanvasElement
</span></span><span style=display:flex><span>        const offscreen = canvas.transferControlToOffscreen()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        const worker = new Worker()
</span></span><span style=display:flex><span>        worker.postMessage({ type: WorkerFunName.main, params: offscreen}, [offscreen])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        const handleMessageError = (error: MessageEvent&lt;any&gt;) =&gt; {
</span></span><span style=display:flex><span>            console.log(error)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        const handleError = (error: ErrorEvent) =&gt; {
</span></span><span style=display:flex><span>            console.log(error)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        worker.addEventListener(&#39;messageerror&#39;, handleMessageError)
</span></span><span style=display:flex><span>        worker.addEventListener(&#39;error&#39;, handleError)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        const handleResize = () =&gt; {
</span></span><span style=display:flex><span>            worker.postMessage({
</span></span><span style=display:flex><span>                type: WorkerFunName.updateSize,
</span></span><span style=display:flex><span>                params: { width: canvas.clientWidth, height: canvas.clientHeight }
</span></span><span style=display:flex><span>            })
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        handleResize()
</span></span><span style=display:flex><span>        window.addEventListener(&#39;resize&#39;, handleResize)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        return () =&gt; {
</span></span><span style=display:flex><span>            worker.removeEventListener(&#39;messageerror&#39;, handleMessageError)
</span></span><span style=display:flex><span>            worker.removeEventListener(&#39;error&#39;, handleError)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }, [canvasRef])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    return (
</span></span><span style=display:flex><span>        &lt;canvas ref={canvasRef} className=&#39;full-screen&#39; /&gt;
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export default HelloOffscreenCanvas
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° index.tsx ä¸­å·²ç»æ²¡æœ‰ä»»ä½• Three.js ç›¸å…³çš„ä»£ç äº†ã€‚</p><p>è¿è¡Œè°ƒè¯•ä¸€åˆ‡æ­£å¸¸ã€‚</p><br><p><strong>æ¥ä¸‹æ¥æˆ‘ä»¬è¦è§£å†³ 2 ä¸ªé—®é¢˜ï¼š</strong></p><ol><li><p>æ§åˆ¶ 3D åœºæ™¯ç”¨åˆ°çš„ OrbitControls ç±»ï¼Œåœ¨æ–°å»ºæ—¶éœ€è¦ä¼ é€’ HTML DOM å…ƒç´ ï¼Œäº¤äº’çš„è¿‡ç¨‹ä¸­éœ€è¦ DOM å…ƒç´ çš„é¼ æ ‡äº‹ä»¶å’Œé”®ç›˜äº‹ä»¶ï¼Œä½†æ˜¯ worker å†…éƒ¨åˆä¸èƒ½è®¿é—® DOM å…ƒç´ ï¼Œé‚£è¯¥å¦‚ä½•è§£å†³ï¼Ÿ</p></li><li><p>å‡è®¾æµè§ˆå™¨ä¸æ”¯æŒ OffscreenCanvas ï¼Œé‚£åˆè¯¥å¦‚ä½•æ‹†åˆ†æˆ‘ä»¬çš„ä»£ç å¯ä»¥åšåˆ°å…¼å®¹ï¼Ÿ</p><blockquote><p>åœ¨è½¯ä»¶å¼€å‘æœ¯è¯­ä¸­ï¼Œä¼šä½¿ç”¨ â€œé²æ£’æ€§æˆ–å¥å£®æ€§â€ æ¥æŒ‡ä»£ç çš„å…¼å®¹æ€§å’Œå®¹é”™æ€§ã€‚</p></blockquote></li></ol><br><h2 id=æ¨¡æ‹Ÿå¹¶æ·»åŠ orbitcontrols>æ¨¡æ‹Ÿå¹¶æ·»åŠ OrbitControls<a hidden class=anchor aria-hidden=true href=#æ¨¡æ‹Ÿå¹¶æ·»åŠ orbitcontrols>#</a></h2><blockquote><p>ä½ éœ€è¦å…ˆå¿˜è®°æˆ‘ä»¬ä¸Šé¢åˆšæ‰è®²è¿‡çš„ç¤ºä¾‹ä»£ç ï¼Œæœ¬å°èŠ‚ä¸­æ‰€æœ‰çš„ä»£ç å’Œä¸Šé¢ç¤ºä¾‹ä»£ç æ²¡æœ‰ä»»ä½•å…³è”ã€‚</p></blockquote><h4 id=ç›®å‰æ— æ³•ä½¿ç”¨orbitcontrolsçš„å›°å¢ƒ>ç›®å‰æ— æ³•ä½¿ç”¨OrbitControlsçš„å›°å¢ƒ<a hidden class=anchor aria-hidden=true href=#ç›®å‰æ— æ³•ä½¿ç”¨orbitcontrolsçš„å›°å¢ƒ>#</a></h4><p>åœ¨ä»¥å‰æ‰€æœ‰çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ é•œå¤´è½¨é“æ§åˆ¶å™¨ï¼Œéƒ½æ˜¯ä½¿ç”¨ä»¥ä¸‹ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>import { OrbitControls } from &#39;three/examples/jsm/controls/OrbitControls&#39;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>const controls = new OrbitControls(camera,canvas)
</span></span><span style=display:flex><span>æˆ–è€…
</span></span><span style=display:flex><span>const controls = new OrbitControls(camera,window.body)
</span></span></code></pre></div><p>OrbitControls æ„é€ å‡½æ•°ç¬¬ 2 ä¸ªå‚æ•°æ— è®ºæ˜¯ canvas è¿˜æ˜¯ window.bodyï¼Œä¸€å®šæ˜¯ä¸€ä¸ª DOM å…ƒç´ ã€‚</p><p>æˆ‘ä»¬å·²ç»å°† Three.js ç›¸å…³ä»£ç éƒ½è½¬ç§»åˆ°äº† Worker å†…éƒ¨ï¼Œä½†æ˜¯Web Worker å†…éƒ¨æ˜¯æ— æ³•è·å– DOM å…ƒç´ çš„ï¼Œé‚£ä¹ˆæ„å‘³ç€ OrbitControls æ ¹æœ¬å°±æ— æ³•åˆå§‹åŒ–ã€‚</p><blockquote><p>ä¸è¦æƒ³ç€å°è¯•å°† DOM å…ƒç´ ä½œä¸º å‚æ•°ï¼Œä½¿ç”¨ .postMessage() å‡½æ•°ä¼ é€’ç»™ Worker å†…éƒ¨ï¼Œå› ä¸º .postMessage() å‡½æ•°ä¸­çš„å‚æ•°å¹¶ä¸æ˜¯ä¼ é€’å¼•ç”¨ï¼Œè€Œæ˜¯ç›´æ¥æ·±åº¦å¤åˆ¶ä¸€ä»½ã€‚</p></blockquote><br><h4 id=é‚£ä¹ˆç©¶ç«Ÿè¯¥æ€ä¹ˆåŠå‘¢>é‚£ä¹ˆç©¶ç«Ÿè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ<a hidden class=anchor aria-hidden=true href=#é‚£ä¹ˆç©¶ç«Ÿè¯¥æ€ä¹ˆåŠå‘¢>#</a></h4><p>æˆ‘ä»¬å…ˆç ”ç©¶ä¸€ä¸‹ OrbitControls çš„æºç ï¼š</p><p><a href=https://github.com/mrdoob/three.js/blob/dev/examples/jsm/controls/OrbitControls.js>https://github.com/mrdoob/three.js/blob/dev/examples/jsm/controls/OrbitControls.js</a></p><br><p>æˆ‘æŠŠæºç ä¸­å’Œ Dom å…ƒç´ ç›¸å…³çš„ä¸€äº›å…³é”®ä»£ç æ‘˜å½•å‡ºæ¥ï¼š</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>//è®¾ç½® scope = this
</span></span><span style=display:flex><span>var scope = this; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>var OrbitControls = function ( object, domElement ) {
</span></span><span style=display:flex><span>  //ä¸‹é¢è¿™è¡Œä»£ç ç›¸å½“äº scope.domElement = domElement
</span></span><span style=display:flex><span>  this.domElement = domElement;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>//æ·»åŠ é¼ æ ‡å³é”®(ä¸Šä¸‹æ–‡)èœå•äº‹ä»¶ä¾¦å¬
</span></span><span style=display:flex><span>scope.domElement.addEventListener( &#39;contextmenu&#39;, onContextMenu);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>//æ·»åŠ è§¦æ§ç¬”å’Œé¼ æ ‡æ‘ä¸‹äº‹ä»¶ä¾¦å¬
</span></span><span style=display:flex><span>scope.domElement.addEventListener( &#39;pointerdown&#39;, onPointerDown);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>//æ·»åŠ é¼ æ ‡æ»šè½´äº‹ä»¶ä¾¦å¬
</span></span><span style=display:flex><span>scope.domElement.addEventListener( &#39;wheel&#39;, onMouseWheel );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>//æ·»åŠ è§¦æ‘¸å¼€å§‹ã€ç»“æŸã€ç§»åŠ¨äº‹ä»¶ä¾¦å¬
</span></span><span style=display:flex><span>scope.domElement.addEventListener( &#39;touchstart&#39;, onTouchStart);
</span></span><span style=display:flex><span>scope.domElement.addEventListener( &#39;touchend&#39;, onTouchEnd);
</span></span><span style=display:flex><span>scope.domElement.addEventListener( &#39;touchmove&#39;, onTouchMove);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>//æ·»åŠ é”®ç›˜äº‹ä»¶ä¾¦å¬
</span></span><span style=display:flex><span>scope.domElement.addEventListener( &#39;keydown&#39;, onKeyDown);
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>if ( state !== STATE.NONE ) {
</span></span><span style=display:flex><span>    //æ·»åŠ è§¦æ§ç¬”å’Œé¼ æ ‡ç§»åŠ¨äº‹ä»¶ä¾¦å¬
</span></span><span style=display:flex><span>    scope.domElement.ownerDocument.addEventListener( &#39;pointermove&#39;, onPointerMove, false );
</span></span><span style=display:flex><span>    //æ·»åŠ è§¦æ§ç¬”å’Œé¼ æ ‡æ¾å¼€äº‹ä»¶ä¾¦å¬
</span></span><span style=display:flex><span>    scope.domElement.ownerDocument.addEventListener( &#39;pointerup&#39;, onPointerUp, false );
</span></span><span style=display:flex><span>    scope.dispatchEvent( startEvent );
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>è¡¥å……è¯´æ˜ï¼šåœ¨æœ€æ–°çš„æµè§ˆå™¨äº‹ä»¶ä¸­ pointer ç›¸å…³äº‹ä»¶å³åŒ…å«è§¦æ§ç¬”ï¼Œä¹ŸåŒ…å«é¼ æ ‡ã€‚æ‰€ä»¥ pointerdownã€pointermoveã€pointerup è¿™ 3 ä¸ªäº‹ä»¶å¯¹åº” è§¦æ§ç¬”æˆ–é¼ æ ‡ å¯¹åº”çš„äº‹ä»¶ï¼Œç›¸å½“äºæ˜¯ 2 è€…çš„åˆä½“ã€‚</p></blockquote><br><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬åˆå§‹åŒ–ä¼ é€’ç»™ OrbitControls çš„ DOM å…ƒç´ ä¸»è¦æ˜¯ç”¨æ¥æ·»åŠ å„ç§äº‹ä»¶ä¾¦å¬ã€‚</p><blockquote><p>å½“ç„¶ OrbitControls ä»£ç ä¸­ä¹Ÿæœ‰å¯¹åº”çš„ removeEventListener ç§»é™¤äº‹ä»¶ä¾¦å¬ã€‚</p></blockquote><blockquote><p>è¡¥å……ä¸€ç‚¹ï¼šcontextmenu äº‹ä»¶è™½ç„¶ç›®å‰éƒ¨åˆ†æµè§ˆå™¨æ”¯æŒ(ä¸»è¦æ˜¯ç«ç‹æµè§ˆå™¨)ï¼Œä½†æ˜¯åœ¨ MDN çš„æ–‡æ¡£ä¸­å·²ç»æ˜ç¡®è¯¥äº‹ä»¶å³å°†è¢«åºŸé™¤ã€‚</p></blockquote><br><p><strong>é‡ç‚¹æ¥äº†ï¼Œè¯·å¬å¥½ï¼š</strong></p><ol><li><p>æ—¢ç„¶ OrbitControls éœ€è¦ DOM å…ƒç´ çš„ç›®çš„æ˜¯ä¸ºäº†è·å–å¹¶æ·»åŠ å„ç§äº‹ä»¶ä¾¦å¬</p></li><li><p>è€Œ Worker ä¸­æ— æ³•è·å– DOM å…ƒç´ </p></li><li><p>é‚£ä¹ˆæœ‰æ²¡æœ‰å¯èƒ½æˆ‘ä»¬è™šæ‹Ÿå‡ºæ¥ä¸€ä¸ªå¯¹è±¡ï¼Œè®©è¯¥å¯¹è±¡æ‹¥æœ‰å’Œ DOM å…ƒç´ ç›¸åŒçš„äº‹ä»¶ API</p><blockquote><p>æ¢å¥è¯è¯´ï¼Œå°±æ˜¯è®©è¿™ä¸ªè™šæ‹Ÿå‡ºæ¥çš„å¯¹è±¡å…·å¤‡æŠ›å‡ºäº‹ä»¶çš„èƒ½åŠ›</p></blockquote><blockquote><p>è¡¥å……ä¸€ç‚¹ï¼Œè¿™é‡Œè¯´çš„ DOM äº‹ä»¶å…¶å®æœ‰ 2 ç§ï¼š</p><ol><li>DOM å…ƒç´ ä¸Šçš„å„ç§ç”¨æˆ·äº¤äº’ 5 ç§äº‹ä»¶ï¼šé¼ æ ‡äº‹ä»¶ã€æ»šè½´äº‹ä»¶ã€é”®ç›˜äº‹ä»¶ã€è§¦æ‘¸äº‹ä»¶ã€å³é”®èœå•äº‹ä»¶</li><li>æµè§ˆå™¨çª—å£å°ºå¯¸å‘ç”Ÿå˜åŒ–å¼•å‘ DOM å…ƒç´ å°ºå¯¸å‘ç”Ÿå˜åŒ–çš„ window resize äº‹ä»¶</li><li>æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯åˆ†åˆ«æ¨¡æ‹Ÿå‡ºä»¥ä¸Š 6 ç§äº‹ä»¶</li></ol></blockquote></li><li><p>ç„¶åæˆ‘ä»¬è®© OrbitControls å»ä¾¦å¬è¿™ä¸ªè™šæ‹Ÿå¯¹è±¡æ‰€å‘å‡ºçš„å„ç§äº‹ä»¶</p></li><li><p>ä¹Ÿå°±æ˜¯è¯´è®©è¿™ä¸ªè™šæ‹Ÿå¯¹è±¡ä»£æ›¿çœŸå®çš„ DOM å…ƒç´ ï¼Œä»¥æ­¤æ¥è§£å†³æˆ‘ä»¬ç›®å‰çš„å›°å¢ƒ</p></li></ol><br><p><strong>æ€è·¯æœ‰äº†ï¼Œé‚£è¯¥å…·ä½“æ€ä¹ˆåšå‘¢ï¼Ÿ</strong></p><p>é¦–å…ˆæˆ‘ä»¬è¦æ˜ç™½ä¸€ä»¶äº‹ï¼ŒåŸç”Ÿ DOM å¯¹åº”çš„å±æ€§ã€æ–¹æ³•ã€äº‹ä»¶ã€ä»¥åŠäº‹ä»¶æºå¸¦çš„å±æ€§ ç§ç±»ç¹å¤šä¸”å¤æ‚ã€‚</p><p>è€Œ OrbitControls å¹¶ä¸æ˜¯æ¯ä¸€ä¸ªå±æ€§ã€æ–¹æ³•ã€äº‹ä»¶ã€äº‹ä»¶æ¯ä¸€ä¸ªå±æ€§ éƒ½ä½¿ç”¨åˆ°äº†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ‰€è°“çš„ â€œæ¨¡æ‹Ÿâ€ä¸éœ€è¦ 100% ä¸€æ¨¡ä¸€æ ·ï¼Œæˆ‘ä»¬åªéœ€è¦æä¾› OrbitControls éœ€è¦çš„å³å¯ã€‚</p><p>ç©¶ç«Ÿéœ€è¦æ¨¡æ‹Ÿå‡º DOM å…ƒç´ å“ªäº›å±æ€§å’Œæ–¹æ³•ï¼Œæˆ‘ä»¬ä¼šåœ¨å…·ä½“ä»£ç æ—¶è®²è§£ã€‚</p><p>æ­¤åˆ»ï¼Œæˆ‘ä»¬åªä»¥äº‹ä»¶æºå¸¦çš„å±æ€§æ¥ä¸¾ä¾‹è¯´æ˜ï¼š</p><ol><li><p>å¯¹äºé¼ æ ‡æ»šè½´æ»šåŠ¨æ¥è¯´ï¼ŒOrbitControls åªéœ€è¦ä½¿ç”¨åˆ°è¯¥äº‹ä»¶çš„ deltaY å€¼</p></li><li><p>å¯¹äºé”®ç›˜äº‹ä»¶æ¥è¯´ï¼ŒOrbitControls åªéœ€è¦ä½¿ç”¨åˆ°è¯¥äº‹ä»¶çš„ ctrlKeyã€metaKeyã€shiftKeyã€keyCode å€¼</p><blockquote><p>meta é”®ï¼Ÿ</p><p>è¿™ä¸ª meta é”®åœ¨ Windows é”®ç›˜ä¸Šç›¸å½“äº windows é”®ã€åœ¨è‹¹æœé”®ç›˜ä¸Šæ˜¯ä¸€ä¸ªå››ç“£çš„å°èŠ±ã€‚</p></blockquote><blockquote><p>åœ¨ OrbitControls å†…éƒ¨å¹¶æœªä½¿ç”¨åˆ° altKey å€¼</p></blockquote><blockquote><p>æ³¨æ„ï¼šç”±äº OrbitControls ä»…ä½¿ç”¨åˆ°é”®ç›˜ ä¸Š/ä¸‹/å·¦/å³ 4 ä¸ªé”®ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä¸»åŠ¨è¿‡æ»¤æ‰ä¸€äº›æ— ç”¨çš„æ‘é”®ï¼Œæ¢å¥è¯è¯´ä¹Ÿå°±æ˜¯æå‰åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦æ˜¯ä»¥ä¸Š 4 ä¸ªæ–¹å‘é”®ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç›´æ¥è·³è¿‡ï¼Œä¸ä¼ é€’è¯¥äº‹ä»¶</p></blockquote><blockquote><p>æ³¨æ„ï¼šå¯¹äºç›®å‰ç‰ˆæœ¬ Three.js r126 ç‰ˆæœ¬è€Œè¨€ï¼ŒOrbitControls é”®ç›˜äº‹ä»¶è¯»å–ä½¿ç”¨çš„æ˜¯ keyCodeï¼Œä½†æ˜¯ event.keyCode äº‹å®ä¸Šå·²ç»ä¸è¢«æ¨èä½¿ç”¨ï¼Œå»ºè®®ä½¿ç”¨ event.code å±æ€§ã€‚</p><p>æ‰€ä»¥æˆ‘é¡ºå¸¦å‘ Three.js å®˜æ–¹æäº¤äº† PRï¼Œå°† keyCode ä¿®æ”¹ä¸º codeï¼Œè¿™ä¸ª PR å·²ç»è¢«å®˜æ–¹å®¡æŸ¥é€šè¿‡äº†ï¼Œä¼šåœ¨ r127 ç‰ˆæœ¬ä¸­ä½¿ç”¨ã€‚å› æ­¤ï¼Œæˆ‘ä¹Ÿæˆä¸º Three.js ä»£ç è´¡çŒ®è€…äº†ã€‚</p><p>æˆ‘æäº¤çš„è¿™ä¸ª PRï¼š<a href=https://github.com/mrdoob/three.js/pull/21409>https://github.com/mrdoob/three.js/pull/21409</a></p></blockquote><blockquote><p>å…³äºä¸ºä»€ä¹ˆä¸å†æ¨èä½¿ç”¨ event.keyCode ä¸»è¦æ˜¯å› ä¸º keyCode ä¸èƒ½å¤Ÿæ¯”è¾ƒæ¸…æ™°æ­£ç¡®è¿”å›é”®ç›˜æ‰€æ‘é”®ï¼Œä¾‹å¦‚ å†’å·å’Œåˆ†å· éƒ½æ˜¯åŒä¸€ä¸ªé”®ï¼Œæ­¤æ—¶ keyCode å°±æ— æ³•ç²¾ç¡®åŒºåˆ†ã€‚</p></blockquote></li><li><p>å¯¹äºé¼ æ ‡äº‹ä»¶ï¼ŒOrbitControls éœ€è¦ä½¿ç”¨åˆ°è¯¥äº‹ä»¶çš„ pointerTypeã€buttonã€clientXã€clientYã€ctrlKeyã€metaKeyã€shiftKey å€¼</p></li><li><p>å¯¹äºè§¦æ‘¸(touch)äº‹ä»¶ï¼ŒOrbitControls éœ€è¦ä½¿ç”¨æ¯ä¸€ä¸ª è§¦æ‘¸ç‚¹çš„ pageXã€pageY å±æ€§å€¼</p></li><li><p>&mldr;</p></li></ol><br><p>æˆ‘ä»¬éœ€è¦è®© â€œè™šæ‹Ÿå¯¹è±¡â€ æŠ›å‡º â€œè™šæ‹Ÿäº‹ä»¶â€ï¼Œå¹¶ä¸”è™šæ‹Ÿäº‹ä»¶æ‹¥æœ‰ä¸Šé¢é‚£äº›å±æ€§å€¼ã€‚</p><blockquote><p>è¡¥å……è¯´æ˜ï¼šè¿™é‡Œæ‰€è¯´çš„ â€œæŠ›å‡ºäº‹ä»¶â€ æš—å« 2 ç§äº‹ä»¶ï¼š</p><ol><li><p>ç”¨æˆ·äº¤äº’äº‹ä»¶ï¼šé¼ æ ‡äº‹ä»¶ã€æ»šè½´äº‹ä»¶ã€é”®ç›˜äº‹ä»¶&mldr;</p></li><li><p>æµè§ˆå™¨çª—å£å˜åŒ–å¼•å‘ â€œDOM å…ƒç´ â€ å†…éƒ¨å°ºå¯¸å±æ€§ç›¸å…³çš„ä¿®æ”¹äº‹ä»¶</p></li></ol><blockquote><p>é™¤äº† window æ‹¥æœ‰ resize äº‹ä»¶ä¹‹å¤–ï¼Œæ™®é€š DOM å…ƒç´ æ˜¯ä¸å…·å¤‡ resize äº‹ä»¶çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªåŸæœ¬ä¸å­˜åœ¨çš„ DOM å…ƒç´  resize è¿½åŠ åˆ° æˆ‘ä»¬çš„æ¶ˆæ¯ä¸­ï¼Œå¯¹äº ç”¨æˆ·äº¤äº’äº‹ä»¶ æˆ‘ä»¬é€‰æ‹©ç›´æ¥æŠ›å‡ºã€å¯¹äº window resize å¼•å‘çš„å°ºå¯¸ä¿®æ”¹äº‹ä»¶ï¼Œæˆ‘ä»¬é€‰æ‹©å†…éƒ¨ç›´æ¥å¤„ç†ã€‚</p></blockquote></blockquote><br><p><strong>å±æ€§è¡¥å……è¯´æ˜ï¼š</strong></p><p>åœ¨ OrbitControls å†…éƒ¨ï¼Œè¿˜ä¼šå¯¹ç›‘å¬çš„ DOM å…ƒç´ çš„æ ¹å…ƒç´ æ·»åŠ  2 ä¸ªäº‹ä»¶ä¾¦å¬ã€‚</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>// scope = this
</span></span><span style=display:flex><span>scope.domElement.ownerDocument.addEventListener( &#39;pointermove&#39;, onPointerMove );
</span></span><span style=display:flex><span>scope.domElement.ownerDocument.addEventListener( &#39;pointerup&#39;, onPointerUp );
</span></span></code></pre></div><p>å› æ­¤æˆ‘ä»¬æ¨¡æ‹Ÿçš„å…ƒç´ è¿˜è¦æ‹¥æœ‰ .ownerDocument å±æ€§å€¼ã€‚</p><blockquote><p>åœ¨åé¢çš„å®é™…ä»£ç ä¸­ä½ ä¼šçœ‹åˆ°ï¼Œæˆ‘ä»¬ä¼šè®© æ¨¡æ‹Ÿå…ƒç´  .ownerDocument æŒ‡å‘è‡ªèº«ã€‚</p><p>this.ownerDocument = this</p></blockquote><br><p><strong>documentè¡¥å……è¯´æ˜ï¼š</strong></p><p>åœ¨ OrbitControls ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œæœ‰ä»¥ä¸‹ä»£ç ï¼š</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>if ( domElement === undefined ) console.warn( &#39;THREE.OrbitControls: The second parameter &#34;domElement&#34; is now mandatory.&#39; );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>if ( domElement === document ) console.error( &#39;THREE.OrbitControls: &#34;document&#34; should not be used as the target &#34;domElement&#34;. Please use &#34;renderer.domElement&#34; instead.&#39; );
</span></span></code></pre></div><p>ä¹Ÿå°±æ˜¯è¯´åœ¨åˆå§‹åŒ– OrbitControls æ—¶ä¼šå¯¹è¦ä¾¦å¬çš„ DOM å…ƒç´ è¿›è¡Œæ£€æŸ¥ã€‚åœ¨ç¬¬ 2 è¡Œä»£ç ä¸­éœ€è¦ä½¿ç”¨åˆ° document è¿™ä¸ªå¯¹è±¡ï¼Œä½†æ˜¯åœ¨ web worker ä¸­æ ¹æœ¬æ— æ³•è®¿é—® documentï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»™ worker æ·»åŠ ä¸€ä¸ª document å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>//@ts-ignore
</span></span><span style=display:flex><span>self.document = {}
</span></span></code></pre></div><ol><li><p>æ·»åŠ  //@ts-ignore è¿™æ ·æ³¨é‡Šï¼Œå¯ä»¥è®© TypeScript å¿½ç•¥ä¸‹é¢ä¸€è¡Œä»£ç çš„æ£€æŸ¥ã€‚</p><blockquote><p>å› ä¸º window.document åœ¨ TS ç‰ˆæœ¬é‡Œè¢«å®šä¹‰ä¸º åªè¯»å¯¹è±¡ï¼Œæ˜¯æ— æ³•ä¿®æ”¹çš„ã€‚</p><p>å¦‚æœæˆ‘ä»¬ä¸é€‰æ‹©å¿½ç•¥ TS æ£€æŸ¥ï¼Œå½“å»æ‰§è¡Œ self.document = {} æ—¶ TS å°±ä¼šæŠ¥é”™ã€‚</p></blockquote></li><li><p>æˆ‘ä»¬æ·»åŠ çš„ self.document = {} çº¯ç²¹æ˜¯ä¸ºäº†è®© OrbitControls æ„é€ å‡½æ•°å¯ä»¥å»è®¿é—®åˆ° document å¯¹è±¡ï¼Œé¿å…æŠ¥é”™ã€‚</p></li></ol><br><p><strong>æ‰€è°“çš„ â€œæŠ›å‡ºäº‹ä»¶â€ å®ç°çš„é€”å¾„æ˜¯ç”± æˆ‘ä»¬è™šæ„å‡ºçš„ä¸€ä¸ª äº‹ä»¶æ´¾å‘å™¨ æ¥å®ç°çš„ã€‚</strong></p><p><strong>è¯¥äº‹ä»¶æ´¾å‘å™¨çš„ 3 ä¸ªåŠŸèƒ½è´£ä»»ï¼š</strong></p><ol><li>ç›‘å¬åŠŸèƒ½ï¼šç›‘å¬çœŸå®DOMå…ƒç´ äº‹ä»¶ï¼šç”¨æˆ·äº¤äº’äº‹ä»¶ã€æµè§ˆå™¨å°ºå¯¸å˜åŒ–äº‹ä»¶</li><li>äº‹ä»¶è½¬åŒ–ï¼šå°†ç›‘å¬åˆ°çš„äº‹ä»¶å†…å®¹ï¼Œè½¬åŒ–ä¸ºä¸€æ¡æ•°æ®ï¼Œè¯¥æ•°æ®åŒ…å«è¯¥äº‹ä»¶ä¸­ OrbitControls æ‰€éœ€è¦çš„å„ç§å±æ€§å€¼</li><li>æ¶ˆæ¯ä¼ é€’ï¼šå°†äº‹ä»¶è½¬åŒ–åçš„æ•°æ®ï¼Œé€šè¿‡ web worker çš„ postMessage() ä¼ é€’ç»™ web worker</li></ol><br><p><strong>æ‰€è°“çš„â€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€ï¼Œä¹Ÿå°±æ˜¯åœ¨ web worker ä¸­å·¥ä½œçš„ DOM å…ƒç´ ã€‚</strong></p><p><strong>è¯¥â€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€çš„ 2 ä¸ªåŠŸèƒ½è´£ä»»ï¼š</strong></p><ol><li>æ¨¡æ‹Ÿ DOM å…ƒç´ çš„å±æ€§å’Œæ–¹æ³•</li><li>å¤„ç† DOM å…ƒç´ éœ€è¦å¤„ç†çš„å„ç§äº‹ä»¶</li></ol><p><strong>è¯¥â€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€çš„ç”Ÿå‘½å·¥ä½œæµç¨‹ä¸ºï¼š</strong></p><ol><li><p>index.tsx ä¸­æ·»åŠ å¯¹ çœŸå® DOM å…ƒç´ çš„ç›‘å¬ï¼Œå¹¶ä¸”é€šçŸ¥ worker åˆ›å»ºâ€œæ¨¡æ‹Ÿå…ƒç´ â€çš„æ¶ˆæ¯</p></li><li><p>worker.ts ä¸­æ¥æ”¶æ¶ˆæ¯ï¼Œå¼€å§‹åˆ›å»ºä¸€ä¸ª â€œæ¨¡æ‹Ÿå…ƒç´ â€ï¼Œå¹¶ä¸”æŠŠè¯¥å…ƒç´ ä¼ é€’ç»™ OrbitControls</p></li><li><p>index.tsx ä¸­ç›‘å¬åˆ°çœŸå® DOM å…ƒç´ è§¦å‘çš„å„ç§äº‹ä»¶ï¼Œå°†è¯¥äº‹ä»¶åˆ†æå¤„ç†ï¼Œè½¬åŒ–ä¸ºä¸€æ¡çº¦å®šå¥½çš„æ¶ˆæ¯ å¹¶å‘é€ç»™ worker</p></li><li><p>worker.ts ä¸­æ¥æ”¶åˆ°äº‹ä»¶æ¶ˆæ¯åï¼Œå°†è¯¥æ¶ˆæ¯è½¬å‘ç»™ â€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€</p></li><li><p>â€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€ æ¥æ”¶è¯¥æ¶ˆæ¯ï¼Œç„¶åå°†è¯¥æ¶ˆæ¯(åŒ…å«äº‹ä»¶ç±»å‹ã€äº‹ä»¶å±æ€§)æŠ›å‡ºï¼Œä¾› OrbitControls ä½¿ç”¨</p><blockquote><p>æˆ‘ä»¬æŠ›å‡ºçš„äº‹ä»¶ï¼Œä¹Ÿæ˜¯æ¨¡æ‹Ÿå‡ºæ¥çš„äº‹ä»¶ï¼Œå¹¶ä¸æ˜¯åŸå§‹ DOM äº‹ä»¶ï¼Œåªä¸è¿‡æˆ‘ä»¬æ¨¡æ‹Ÿå‡ºæ¥çš„äº‹ä»¶ä¸­æ°å¥½åŒ…å« OrbitControls éœ€è¦çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ã€‚</p></blockquote><blockquote><p>åœ¨ web worker ä¸­å·¥ä½œçš„ OrbitControlsï¼Œä»å§‹è‡³ç»ˆéƒ½ä¸çŸ¥é“è‡ªå·±æ“ä½œçš„å…¶å®æ˜¯ä¸€ä¸ªå‡çš„ DOM å…ƒç´ ï¼Œä»¥åŠç›‘å¬çš„äº‹ä»¶ä¹Ÿæ˜¯å‡çš„ DOM äº‹ä»¶ã€‚</p></blockquote></li></ol><br><p><strong>æ•´ä¸ªäº‹ä»¶çš„æµç¨‹ä¸ºï¼š</strong></p><p><strong>çœŸå®DOMäº‹ä»¶ > è½¬åŒ–ä¸ºæ¶ˆæ¯ > å‘é€ç»™ worker > ä¼ é€’ç»™â€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€ > æŠ›å‡ºè¯¥æ¶ˆæ¯(ç›¸å½“äºæŠ›å‡ºè¯¥äº‹ä»¶)</strong></p><p>é€šè¿‡ äº‹ä»¶ > æ¶ˆæ¯ > æ¶ˆæ¯ > äº‹ä»¶ è¿™æ ·ä¸€æ³¢æ“ä½œè¿‡åï¼Œå¯ä»¥è®© OrbitControls å°±åƒç›‘æ§çœŸå® DOM å…ƒç´ ä¸€æ ·ç›‘æ§è¿è¡Œåœ¨ web worker ä¸­çš„é‚£ä¸ª â€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€ã€‚</p><blockquote><p>æˆ‘æ•…æ„ä¸€ç›´ä½¿ç”¨ â€œæ¨¡æ‹Ÿçš„DOMå…ƒç´ â€è¿™ä¸ªè¯ï¼Œè€Œæ²¡æœ‰ä½¿ç”¨ â€œè™šæ‹ŸDOMâ€ï¼Œå°±æ˜¯ä¸ºäº†è®©æˆ‘ä»¬é¿å…å’Œ react ä¸­ è™šæ‹ŸDOM çš„ä¸€è¯å¼„æ··æ·†ã€‚</p></blockquote><br><p><strong>å…³äº äº‹ä»¶æŠ›å‡º çš„è¡¥å……è¯´æ˜ï¼š</strong></p><p>æˆ‘ä»¬è®© â€œè™šæ„å…ƒç´ â€ ç»§æ‰¿äº Three å·²å†…ç½®çš„ EventDispatcherï¼Œè¿™æ · â€œè™šæ„å…ƒç´ â€ å°± å…·å¤‡ .dispatcheEvent() æ–¹æ³•ã€‚</p><div class=highlight><pre tabindex=0 style=color:#3c3836;background-color:#fbf1c7;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>import { EventDispatcher } from &#39;three&#39;
</span></span></code></pre></div><br><p>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ åŸç”Ÿ JS æä¾›çš„ EventTarget ï¼Ÿ</p><p>è¿™æ˜¯å› ä¸ºåŸç”Ÿ JS æä¾›çš„ EventTarget è™½ç„¶ä¹Ÿæœ‰ .dispatcheEvent()ï¼Œä½†é—®é¢˜æ˜¯å®ƒåªå¯ä»¥æŠ›å‡º JS ä¸­çš„ Event å®ä¾‹ï¼Œè€Œæˆ‘ä»¬åœ¨ worker ä¸­å¹¶ä¸èƒ½ä½¿ç”¨ Eventã€‚</p><br><p><strong>è¡¥å……è¯´æ˜ï¼š</strong></p><p>æ— è®º JS åŸç”Ÿçš„ EventTargetï¼Œè¿˜æ˜¯ Three.js å†…ç½®çš„ EventDispatcherï¼Œä»–ä»¬å†…éƒ¨æœ¬è´¨ä¸Šéƒ½æ˜¯æ‰§è¡Œçš„æ˜¯å‡½æ•°è°ƒç”¨ï¼Œæ‰€ä»¥ä»–ä»¬çš„æ‰§è¡Œè¿‡ç¨‹éƒ½æ˜¯ åŒæ­¥çš„ã€‚</p><blockquote><p>æµè§ˆå™¨ä¸­åŸç”Ÿçš„å„ç§äº‹ä»¶å¤„ç†å‡½æ•° å…¶å®æ˜¯å¼‚æ­¥çš„ã€‚</p></blockquote><br><p><strong>æ•´ä½“è§£å†³æ€è·¯å›é¡¾ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥å®ç°ï¼Ÿ</strong></p><p>å›é¡¾ä¸€ä¸‹æœ¬å°èŠ‚å¼€å¤´çš„å›°å¢ƒé—®é¢˜ï¼šweb worker æœ¬èº«ä¸å¯ä»¥è®¿é—®çœŸå® DOM å…ƒç´ ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬ DOM äº‹ä»¶ã€‚</p><br><p><strong>é‚£ä¹ˆæˆ‘ä»¬ç©¶ç«Ÿæ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿä»¥åŠä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥åšåˆ°ï¼Ÿ</strong></p><p><strong>ç­”ï¼šæœºç¼˜å·§åˆ</strong></p><p>**ç¬¬1ç§æœºç¼˜å·§åˆï¼š**è™½ç„¶ web worker æ— æ³•è®¿é—®çœŸå®çš„ DOM å…ƒç´ ï¼Œä½†æ˜¯ canvas å…ƒç´ å¯¹åº”çš„ OffscreenCanvas å´æ˜¯ä¸€ä¸ªä¾‹å¤–ï¼Œé€šè¿‡ä¸»çº¿ç¨‹è®©å‡º canvas ç»˜åˆ¶æ§åˆ¶æƒï¼Œè®© web worker æ‹¥æœ‰äº†å¯ä»¥æ“ä½œå¹¶ç»˜åˆ¶ canvas å…ƒç´ çš„èƒ½åŠ›ã€‚</p><blockquote><p>ç›®å‰ç«ç‹æµè§ˆå™¨å¹¶ä¸æ”¯æŒ OffscreenCanvasï¼Œæ‰€ä»¥æœ¬ç¤ºä¾‹è¿˜è¦è€ƒè™‘åœ¨é worker æƒ…å†µä¸‹çš„åœºæ™¯åˆ›å»ºã€‚</p></blockquote><br><p>**ç¬¬2ç§æœºç¼˜å·§åˆï¼š**è™½ç„¶ web worker æ— æ³•ç›´æ¥ç›‘å¬çœŸå® DOM å…ƒç´ äº‹ä»¶ï¼Œä½†æ˜¯ web worker å†…éƒ¨å´å¯ä»¥è¿è¡Œ æŠ›å‡ºäº‹ä»¶ è¿™ä¸ªæ“ä½œã€‚äºæ˜¯æˆ‘ä»¬é€šè¿‡ äº‹ä»¶ > æ¶ˆæ¯ > æ¶ˆæ¯ > äº‹ä»¶ çš„æ“ä½œè®© web worker å†…éƒ¨æ¨¡æ‹Ÿå‡ºçš„ DOM å…ƒç´ æ‹¥æœ‰äº†åƒçœŸå® DOM å…ƒç´ ä¸€æ ·çš„å„ç§äº‹ä»¶æŠ›å‡ºæœºåˆ¶ã€‚</p><blockquote><p>å†æ¬¡æé†’ä¸€ä¸‹ï¼šåœ¨ web worker ä¸­ï¼Œä¸å…‰ DOM å…ƒç´ æ˜¯æˆ‘ä»¬æ¨¡æ‹Ÿå‡ºæ¥çš„ï¼Œå°±è¿æŠ›å‡ºçš„ DOM å…ƒç´ äº‹ä»¶ä¹Ÿæ˜¯æˆ‘ä»¬æ¨¡æ‹Ÿå‡ºæ¥çš„ã€‚</p></blockquote><p>æœ€ç»ˆæˆ‘ä»¬è®© web worker ä¸­ OrbitControls æ­£å¸¸è¿è¡Œèµ·æ¥äº†ã€‚</p><br><blockquote><p>å¦‚æœä½ å¯¹æˆ‘ä¸Šé¢çš„è®²è¿°è¿˜ä¸å¤ªç†è§£ï¼Œé‚£ä¹ˆå¤šè¯»å‡ éï¼Œä¸è¦ç€æ€¥æ¥ç€å¾€ä¸‹çœ‹ã€‚å› ä¸ºå¦‚æœæ•´ä½“çš„æ€è·¯ä½ æ²¡æœ‰ç†è§£é€ï¼Œé‚£ä¹ˆä¸‹é¢è¿™äº›å…·ä½“å®ç°çš„ä»£ç ï¼Œé˜…è¯»èµ·æ¥ä¹Ÿä¼šä¸€å¤´é›¾æ°´ã€‚</p></blockquote><blockquote><p>å®è¯å®è¯´ï¼Œåœ¨å­¦ä¹ æœ¬ç« å†…å®¹ï¼Œçœ‹è‹±æ–‡åŸç‰ˆæ•™ç¨‹ï¼Œæˆ‘èŠ±äº†å°†è¿‘ä¸€å‘¨çš„æ—¶é—´ï¼Œæ‰å¼„æ˜ç™½æ•´ä¸ªåŸç†ã€‚</p><p>æœ¬æ–‡è®²çš„å†…å®¹å¯èƒ½æ˜¯æ•´ä¸ª three.js æ•™ç¨‹ä¸­æœ€ç»•ã€æœ€å¤æ‚çš„ï¼Œä½†æ˜¯ä¸ºäº†æ€§èƒ½ä¼˜åŒ–ï¼Œå­¦ä¹ ä¸€ä¸‹æ˜¯éå¸¸å€¼å¾—çš„ã€‚</p></blockquote><br><p><strong>è¡¥å……ä¸€ä¸ªå’Œæœ¬æ–‡æ— å…³çš„çŸ¥è¯†ç‚¹ï¼š</strong></p><p>é™¤äº† window ä¹‹å¤–ï¼Œå…¶ä»– DOM å…ƒç´ å°ºå¯¸å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ˜¯ä¸ä¼šè§¦å‘ä»»ä½•äº‹ä»¶çš„ã€‚</p><ol><li>é€šè¿‡ css ä¿®æ”¹ DOMå…ƒç´ å°ºå¯¸</li><li>å› ä¸º window resize äº‹ä»¶è€Œä¿®æ”¹ DOM å…ƒç´ å°ºå¯¸</li></ol><p>å¦‚æœä½ æƒ³ç›‘å¬æŸ DOM å…ƒç´ å°ºå¯¸çš„å˜åŒ–ï¼Œåœ¨æœ€æ–°çš„ DOM3 æ ‡å‡†ä¸­ï¼Œå¯ä»¥é€šè¿‡ MutationObserver æ¥ç›‘æ§ï¼Œå…·ä½“ç”¨æ³•è¯·æŸ¥é˜… MDN å®˜æ–¹æ–‡æ¡£ã€‚</p><p><a href=https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver>https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver</a></p><br><h3 id=æ•´ä½“æ€è·¯ç¤ºæ„å›¾>æ•´ä½“æ€è·¯ç¤ºæ„å›¾<a hidden class=anchor aria-hidden=true href=#æ•´ä½“æ€è·¯ç¤ºæ„å›¾>#</a></h3><p><img loading=lazy src=https://puxiao.com/demo/using-orbitcontrols-in-worker/using-orbitcontrols-in-worker.jpg alt=using-orbitcontrols-in-worker.jpg></p><br><p>æ¥ä¸‹æ¥å¼€å§‹è®²è§£å…·ä½“ä»£ç å¦‚ä½•å®ç°ã€‚</p><blockquote><p>ç”±äºæˆ‘ä½¿ç”¨çš„æ˜¯ React + TypeScriptï¼ŒåŠ ä¸Šæˆ‘æœ‰ä¸€äº›è‡ªå·±ä»£ç ç†è§£å’Œåˆ’åˆ†ï¼Œæ‰€ä»¥æˆ‘ä¸‹é¢è®²è¿°çš„ä»£ç å’ŒåŸæ•™ç¨‹å¾ˆå¤šåœ°æ–¹éƒ½ä¸ä¸€æ ·ã€‚</p></blockquote><blockquote><p>è¿‡ç¨‹æœ‰ç‚¹å¤æ‚ï¼Œå¸Œæœ›æˆ‘èƒ½è®²æ¸…æ¥šã€‚</p></blockquote><br><h4 id=ä»£ç æ¨¡å—è§„åˆ’>ä»£ç æ¨¡å—è§„åˆ’<a hidden class=anchor aria-hidden=true href=#ä»£ç æ¨¡å—è§„åˆ’>#</a></h4><ol><li><p>å®šä¹‰ä¸€ä¸ªç±» FictionalElement ç»§æ‰¿äº EventDispatcherï¼Œç”¨è¿™ä¸ªç±»çš„å®ä¾‹æ¥æ¨¡æ‹Ÿ â€œDOMå…ƒç´ æœ¬èº«â€</p><blockquote><p>è¯·æ³¨æ„ï¼šFictionalElement åªå…·å¤‡(æ¨¡ä»¿ã€æ¨¡æ‹Ÿ) â€œDOMå…ƒç´ â€ æœ¬èº«çš„ä¸€äº›å±æ€§å’Œæ–¹æ³•(ä¾‹å¦‚ widthã€heightã€leftã€topã€getBoundingClientRect() ç­‰)ï¼Œä½†å¹¶ä¸å…·å¤‡å¯ä»¥ç›´æ¥å’Œ web worker é€šä¿¡çš„èƒ½åŠ›</p></blockquote><blockquote><p>åœ¨æ¨¡æ‹Ÿä¸€äº› â€œæ— ç”¨â€ çš„æ–¹æ³•æ—¶ï¼Œä¾‹å¦‚ focus()ã€preventDefault()ã€stopPropagation()ï¼Œå°†è¯¥æ–¹æ³•ä»£ç ä½“å†…ä¸æ·»åŠ ä»»ä½•ä»£ç ï¼Œåªæ˜¯ä¿è¯æœ‰è¿™ä¸ªæ–¹æ³•ä½†æ— éœ€æœ‰å®é™…æ‰§è¡Œå†…å®¹ã€‚</p></blockquote></li><li><p>å®šä¹‰ä¸€ä¸ªç±» FictionalElementManager ç”¨æ¥åˆ›å»ºå’Œç®¡ç†æ‰€æœ‰ FictionalElement å®ä¾‹</p><blockquote><p>äº‹å®ä¸Šæˆ‘è®¤ä¸ºè¿™ä¸€æ­¥éª¤ä¸æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºå®é™…é¡¹ç›®ä¸­ï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹ç½‘é¡µä¸­éƒ½åªä¼šæœ‰ä¸€ä¸ª ç”¨æˆ·äº¤äº’å…ƒç´ (é€šå¸¸ä¸º canvas æˆ– document.body)ï¼Œå¹¶ä¸ä¼šæœ‰å¤ªå¤šå…ƒç´ éœ€è¦æˆ‘ä»¬ç®¡ç†ã€‚ä½†æ˜¯æœ¬æ–‡å¯¹åº”çš„ <a href=https://threejsfundamentals.org/threejs/lessons/threejs-offscreencanvas.html>åŸç‰ˆæ•™ç¨‹</a> ä¸­æœ‰è¿™ä¸€ç¯èŠ‚(ç®¡ç†å±‚)ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿç»§ç»­éµå¾ªã€‚</p></blockquote><blockquote><p>ä¸ºäº†åŒºåˆ«ä¸åŒçš„ç®¡ç†å¯¹è±¡ï¼Œæˆ‘ä»¬å°†åœ¨å†…éƒ¨ç»™æ¯ä¸€ä¸ª ElementProxyReceiver æ·»åŠ ä¸€ä¸ªå¯¹åº”çš„ id</p><p>åŸç‰ˆæ•™ç¨‹ä¸­ï¼Œid æ˜¯ç”± FictionalElementManager æä¾›çš„ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºè¿™æ ·å¹¶ä¸åˆç†ï¼Œæˆ‘é‡‡ç”¨çš„æ˜¯é€šè¿‡å¤–éƒ¨ä¼ é€’ id ä¸º string ç±»å‹çš„å€¼ã€‚</p></blockquote></li><li><p>å®šä¹‰ä¸€ä¸ªç±» FictionalWindow ç”¨æ¥æ¨¡æ‹Ÿ window</p><blockquote><p>è¯·æ³¨æ„ï¼Œç›®å‰æ¥è¯´ FictionalWindow ä»…ä»…æ˜¯ç»§æ‰¿äº† EventDispatcherï¼Œå¹¶æ²¡æœ‰åšå…¶ä»–è®¾ç½®ï¼Œå…ˆè¿™æ ·åšï¼Œä¹Ÿè®¸æœªæ¥æœ‰å…¶ä»–éœ€æ±‚äº†ï¼Œå†æ ¹æ®éœ€è¦æ‰©å±•å®ƒã€‚</p></blockquote></li><li><p>å®šä¹‰ä¸€ä¸ªç±» ControlsProxy ç”¨æ¥è´Ÿè´£åŸºç¡€çš„ çœŸå®DOMå…ƒç´ ä¸ Web Worker ä¹‹é—´é€šä¿¡ã€‚</p><blockquote><p>å½“æµè§ˆå™¨çª—å£å°ºå¯¸å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿçš„ &ldquo;DOMå…ƒç´ æœ¬èº«"ä¹Ÿåº”è¯¥ä¼šå‘ç”Ÿå°ºå¯¸å˜åŒ–ï¼Œè€Œè¿™ä¸ªå˜åŒ–çš„è§¦å‘å¹¶ä¸æ˜¯ç”± FictionalElement å®Œæˆçš„ï¼Œè€Œæ˜¯ç”± ControlsProxy æ¥å®Œæˆçš„ã€‚</p></blockquote></li><li><p>å®šä¹‰ä¸€ä¸ªç±» OrbitControlsProxy ç»§æ‰¿äº ControlsProxyï¼Œç„¶åé‡å†™ configEventListener() å’Œ dispose()</p><blockquote><p>ä½ å¯èƒ½ç–‘æƒ‘ä¸ºä»€ä¹ˆæˆ‘æ²¡æœ‰ç›´æ¥æŠŠä»£ç å†™åœ¨åŒä¸€ä¸ªç±»é‡Œï¼Œè€Œæ˜¯è¦æ‹†åˆ†æˆ 2 ä¸ªã€‚æˆ‘è¿™æ ·åšçš„åŸå› æ˜¯æƒ³å°†ä¸€äº›åŸºç¡€çš„ã€å…±æ€§çš„å±æ€§å’Œæ–¹æ³•æŠ½ç¦»å‡ºæ¥ï¼Œè¿™æ ·æœªæ¥æœ‰ä¸€å¤©æˆ‘ä»¬è¦å»å®ç°å…¶ä»–è½¨é“æ§åˆ¶å™¨ï¼Œéƒ½å¯ä»¥ç»§æ‰¿äº ControlsProxy</p></blockquote></li><li><p>å®šä¹‰ä¸€ä¸ªç±» WorkerMessageTypeï¼Œç”¨æ¥å®šä¹‰ å‘é€æ¶ˆæ¯ çš„ç±»å‹</p><blockquote><p>æ¯æ¬¡éƒ½é æ‰‹å†™æ¶ˆæ¯ç±»å‹æ˜¯ä¸é è°±çš„ï¼Œä¸‡ä¸€æ‰‹æŠ–æ‹¼å†™é”™å­—æ¯äº†æƒ³æ£€æŸ¥å‡ºæ¥éƒ½ä¸å®¹æ˜“ã€‚</p></blockquote></li><li><p>æ­¤å¤–ï¼Œè™½ç„¶æœ¬æ•™ç¨‹ä¸€ç›´éƒ½æ˜¯ç”¨çš„æ˜¯ TypeScriptï¼Œä½†æ˜¯åœ¨ç¼–å†™è¿™äº›ç±»çš„æ—¶å€™ï¼Œè€ƒè™‘æœ‰äº›äººå¹¶ä¸ä½¿ç”¨ TSï¼Œæ‰€ä»¥æˆ‘é‡‡ç”¨çš„æ˜¯ .js + JSDoc çš„æ–¹å¼ï¼Œé€šè¿‡ JSDoc ä»£ç æ³¨é‡Šçš„å½¢å¼æ¥å®šä¹‰ä¸åŒæ¶ˆæ¯çš„æ•°æ®ç»“æ„ï¼Œæ²¡æœ‰ä½¿ç”¨ .tsã€‚</p><blockquote><p>æˆ‘ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªç¤ºä¾‹è€Œå»å­¦ä¹ äº† JSDocï¼Œæ„Ÿå…´è¶£å¯æŸ¥çœ‹æˆ‘å¦å¤–ä¸€ç¯‡å­¦ä¹ ç¬”è®°ï¼š<a href=https://github.com/puxiao/notes/blob/master/JSDoc%E7%9A%84%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8.md>JSDocçš„å®‰è£…ä¸ä½¿ç”¨.md</a></p></blockquote></li></ol><br><p>ä»¥ä¸Šä»…ä»…æ˜¯ â€œè™šæ„â€ çš„æ ¸å¿ƒä»£ç ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç¼–å†™å¯¹åº”çš„ â€œåº”ç”¨â€ å±‚é¢çš„ä»£ç ï¼š</p><ol><li><p>index.tsxï¼šJS ä¸»åœºæ™¯ main ä»£ç </p></li><li><p>worker.tsï¼šWorker åœºæ™¯ä»£ç </p></li><li><p>create-world.tsï¼šè´Ÿè´£åˆ›å»º Three.js 3D åœºæ™¯çš„æ ¸å¿ƒä»£ç </p><blockquote><p>create-world.ts ä¸­çš„ä»£ç å¹¶ä¸çŸ¥é“è‡ªå·±å°†æ¥æ˜¯è¿è¡Œåœ¨ Worker ä¸­è¿˜æ˜¯è¿è¡Œåœ¨ ä¸»åœºæ™¯ä¸­(Main)</p></blockquote></li></ol><br><p><strong>å¦‚æœä½ èƒ½åšæŒçœ‹åˆ°è¿™é‡Œæ²¡æœ‰è¢«æˆ‘ç»•æ™•ï¼Œé‚£æ­å–œä½ ã€‚</strong></p><p>æ˜¯ä¸æ˜¯è¯¥å±•ç¤ºå…·ä½“ä»£ç äº†ï¼Ÿ</p><br><h3 id=é¡¹ç›®å®é™…ä»£ç >é¡¹ç›®å®é™…ä»£ç <a hidden class=anchor aria-hidden=true href=#é¡¹ç›®å®é™…ä»£ç >#</a></h3><p>åŸç†éƒ½è®²è¿°å®Œäº†ï¼Œä½†æ˜¯æ¯ä¸ªç±»çš„ä»£ç ç»†èŠ‚å®åœ¨æ˜¯å¤ªå¤šï¼Œæˆ‘ä¹Ÿä¸æƒ³å†ç»†è‡´è®²è¿°äº†ï¼Œæ‰€ä»¥åœ¨ Github å•ç‹¬åˆ›å»ºäº†ä¸€ä¸ªé¡¹ç›®ï¼š</p><p><strong><a href=https://github.com/puxiao/using-orbitcontrols-in-worker>https://github.com/puxiao/using-orbitcontrols-in-worker</a></strong></p><br><blockquote><p>ä¸ºäº†è®©å…¨ä¸–ç•Œçš„äººèƒ½çœ‹åˆ°æˆ‘çš„è¿™ä¸ªä»£ç ï¼Œæˆ‘ç«Ÿç„¶å†™äº†ä¸€ä¸ªè‹±æ–‡ç‰ˆ README.MD</p></blockquote><p>ä½ å¯ä»¥ç›´æ¥æŸ¥çœ‹æˆ‘å†™çš„ç®€ä½“ä¸­æ–‡ä»‹ç»æ–‡æ¡£ï¼š</p><p><a href=https://github.com/puxiao/using-orbitcontrols-in-worker/blob/main/README-zh_CN.md>https://github.com/puxiao/using-orbitcontrols-in-worker/blob/main/README-zh_CN.md</a></p><br><h3 id=è¯´ä¸€ä¸‹æˆ‘çš„æ„Ÿå—>è¯´ä¸€ä¸‹æˆ‘çš„æ„Ÿå—<a hidden class=anchor aria-hidden=true href=#è¯´ä¸€ä¸‹æˆ‘çš„æ„Ÿå—>#</a></h3><p>æœ¬èŠ‚åé¢çš„ä»£ç å®ç°ï¼ŒèŠ±è´¹äº†æˆ‘æœ‰ 1 ä¸ªæœˆçš„æ—¶é—´ï¼Œæ•´ä¸ªè¿‡ç¨‹å³å……å®æœ‰ç—›è‹¦ã€‚</p><ol><li>ä»é˜…è¯»åŸç‰ˆæ•™ç¨‹ï¼Œå®Œå…¨çœ‹ä¸æ‡‚ ç†è§£ä¸äº†</li><li>åæ¥å¯ä»¥ç†è§£</li><li>æ”¹ä¸ºè‡ªå·±çš„å®ç°æ–¹å¼</li><li>ä¸æ–­å¾—ä¿®æ”¹ã€ä¼˜åŒ–ä»£ç </li><li>ä¸Šä¼ åˆ° Github ç¼–å†™æ–‡æ¡£</li></ol><p>å°½ç®¡æŒæ¡äº†æœ¬ç« æ‰€å†™çš„ç¤ºä¾‹ä»£ç ï¼Œä½†æ˜¯è¿™äº›å¯¹å®é™… Three.js çš„ä½¿ç”¨æå‡å¹¶ä¸ä¼šæœ‰ç«‹ç«¿è§å½±çš„æ•ˆæœã€‚</p><br><h4 id=ä½†æ˜¯>ä½†æ˜¯<a hidden class=anchor aria-hidden=true href=#ä½†æ˜¯>#</a></h4><p>å› ä¸ºä¸æ–­çš„æ·±å…¥å»ç†è§£ï¼Œå­¦ä¹ ï¼Œæˆ‘ä¹Ÿæœ‰å¾ˆå¤šæ”¶è·ï¼š</p><ol><li><p>æˆ‘æˆåŠŸå‘ Three.js è´¡çŒ®äº†è‡ªå·±çš„ä¸€ç‚¹ç‚¹ä»£ç ï¼Œå°¤å…¶æ˜¯åœ¨æäº¤è‡ªå·±çš„ PR è¿‡ç¨‹ä¸­ï¼Œç”¨è¹©è„šè‹±è¯­ä¸ Three.js ä»£ç å®¡æŸ¥äººå‘˜çš„ä¸æ–­æ²Ÿé€šï¼Œæ˜¯ä¸€æ¬¡å¾ˆç¥å¥‡çš„ä½“éªŒã€‚</p></li><li><p>é€šè¿‡ OrbitControlsï¼Œé¡ºå¸¦æˆ‘ä¹Ÿçœ‹äº†å…¶ä»– è½¨é“æ§åˆ¶å™¨çš„ ä¸€äº›æºç ï¼Œäº‹å®ä¸Šæˆ‘åŸæœ¬çš„é‡å¿ƒè®¡åˆ’æ˜¯ç¼–å†™å‡ºæ‰€æœ‰è½¨é“æ§åˆ¶å™¨çš„ ControlsProxy ç‰ˆï¼Œä½†æ˜¯æ—¶é—´å’Œç²¾åŠ›ï¼Œè¿™ä¸ªäº‹æƒ…åªèƒ½æš‚æ—¶æ”¾ä¸‹ï¼Œç­‰å¾…å°†æ¥æˆ–è€…å…¶ä»–æ„Ÿå…´è¶£çš„äººæ¥ç¼–å†™å§ã€‚</p><blockquote><p>ç›®å‰æˆ‘çš„é¡¹ç›®ä¸­åªç¼–å†™äº† OrbitControlsProxy.jsï¼Œå¦‚æœä½ æ„Ÿå…´è¶£ï¼Œä¹Ÿå¯ä»¥å°è¯•ç¼–å†™å‡ºå…¶ä»– è½¨é“æ§åˆ¶å™¨å¯¹åº”çš„ XxxControlsProxyã€‚</p><p>æé†’ï¼šå¦‚æœä½ æƒ³ç¼–å†™å…¶ä»–è½¨é“æ§åˆ¶å™¨çš„ä»£ç†ç®¡ç†ç±»ï¼Œå®ƒéœ€è¦ç»§æ‰¿äº ControlsProxyï¼Œç„¶åé‡å†™ configEventListener() å’Œ dispose() è¿™ 2 ä¸ªæ–¹æ³•ã€‚</p></blockquote></li><li><p>å­¦ä¹ äº† JSDoc æ³¨é‡Šè§„èŒƒï¼Œä¹Ÿå°±æ˜¯å³ä½¿æˆ‘ä»¬ä¸ä½¿ç”¨ TypeScriptï¼Œé€šè¿‡ JSDoc æ³¨é‡Šä¾ç„¶å¯ä»¥è¿›è¡Œç±»å‹å®šä¹‰ã€‚</p><blockquote><p>é€šè¿‡ JSDoc çš„å­¦ä¹ ï¼Œè®©æˆ‘å¯¹ TypeScript æœ‰æ›´åŠ æ·±ä¸€å±‚çš„ç†è§£ã€‚</p><p>æ— è®º TypeScript è¿˜æ˜¯ JSDocï¼Œè¿˜æ˜¯ VSCode IDE æœ¬èº«çš„ä»£ç æç¤ºå’Œè‡ªåŠ¨æ£€æŸ¥ï¼Œæœ¬è´¨ä¸Šéƒ½ä»…ä»…åœ¨ å¼€å‘é˜¶æ®µ å¯¹æˆ‘ä»¬ç¼–å†™çš„ä»£ç è¿›è¡Œçº¦æŸï¼Œå°†æ¥ JS è¿è¡Œé˜¶æ®µå°±ç®¡ä¸äº†é‚£ä¹ˆå¤šäº†ã€‚</p></blockquote></li><li><p>æ¥è§¦äº† //@ts-ignore è¿™ä¸ªç‰¹æ®Šæ³¨é‡Š</p></li></ol><br><h3 id=æœ¬å°èŠ‚ç»“æŸ>æœ¬å°èŠ‚ç»“æŸ<a hidden class=anchor aria-hidden=true href=#æœ¬å°èŠ‚ç»“æŸ>#</a></h3><p>æœ¬å°èŠ‚è‡³æ­¤ç»“æŸï¼ŒåŒæ—¶ä¹Ÿæ„å‘³ç€æœ¬ç³»åˆ—æ•™ç¨‹çš„ â€œä¼˜åŒ–â€ ç¯‡ç« è®²è§£å®Œæˆã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦å¼€å§‹æ–°çš„é˜¶æ®µå­¦ä¹ ï¼Œä¸‹ä¸€é˜¶æ®µæ‰å†³å®šæˆ‘ä»¬ Three.js å®é™…åº”ç”¨é¢†åŸŸ â€œè´¨çš„é£è¶Šâ€ã€‚</p><br><p><strong>ä¸‹ä¸€é˜¶æ®µï¼Œæˆ‘ä»¬è¦å¼€å§‹å­¦ä¹  Three.js ä¸­å¸¸è§çš„å„ç§åº”ç”¨åœºæ™¯è§£å†³æ–¹æ¡ˆã€‚</strong></p><p>åŠ æ²¹ï¼Œå¥½ç©æœ‰è¶£çš„äº‹æƒ…ç»ˆäºè¦å¼€å§‹äº†ã€‚</p><br></div><footer class=post-footer><ul class=post-tags><li><a href=https://bablvsj.github.io/tags/three.js/>Three.js</a></li></ul><nav class=paginav><a class=prev href=https://bablvsj.github.io/posts/threejs/21-three.js%E4%BC%98%E5%8C%96%E4%B9%8B%E5%90%88%E5%B9%B6%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%8A%A8%E7%94%BB/><span class=title>Â« Prev</span><br><span>21 Three.jsä¼˜åŒ–ä¹‹åˆå¹¶å¯¹è±¡çš„åŠ¨ç”»</span></a>
<a class=next href=https://bablvsj.github.io/posts/threejs/23-three.js%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E4%B9%8B%E5%8A%A0%E8%BD%BD.obj%E6%A8%A1%E5%9E%8B/><span class=title>Next Â»</span><br><span>23 Three.jsè§£å†³æ–¹æ¡ˆä¹‹åŠ è½½.objæ¨¡å‹</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://bablvsj.github.io>Bablvsj's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span><div class=flex-c-d><a class=flex-d-c href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target=_blank><span>æœ¬ç«™ç”±</span><img width=60 src=/images/upyun.png>æä¾›CDNåŠ é€Ÿ/äº‘å­˜å‚¨æœåŠ¡</a></div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>